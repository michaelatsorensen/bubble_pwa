<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Bubble">
<meta name="theme-color" content="#0a0a0f">
<title>Bubble ‚Äî Network Radar</title>
<script>
// HD App icon embedded
const BUBBLE_ICON = "./icon-192.png";
document.addEventListener('DOMContentLoaded', () => {
  // Set apple touch icons dynamically
  ['180','167','152','120'].forEach(s => {
    const l = document.createElement('link');
    l.rel = 'apple-touch-icon';
    l.setAttribute('sizes', s+'x'+s);
    l.href = BUBBLE_ICON;
    document.head.appendChild(l);
  });
});
</script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&family=Sora:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<!-- ============================================================
     BUBBLE APP ‚Äî FUNKTIONEL VERSION
     
     OPS√ÜTNING (2 minutter):
     1. G√• til supabase.com ‚Üí dit projekt ‚Üí Settings ‚Üí API
     2. Kopi√©r "Project URL" og inds√¶t nedenfor som SUPABASE_URL
     3. Kopi√©r "anon public" key og inds√¶t som SUPABASE_ANON_KEY
     4. G√• til SQL Editor i Supabase og k√∏r SQL-scriptet fra bubble-setup.sql
     5. Upload denne fil til Netlify Drop (netlify.com/drop)
     6. Del linket med dine 4 iPhones
     ============================================================ -->

<script>
  const SUPABASE_URL  = "https://pfxcsjjxvdtpsfltexka.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_y6BftA4RQw91dLHPXIncag_oGomBk-A";
</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

/* ‚îÄ‚îÄ DESIGN TOKENS ‚îÄ‚îÄ */
:root {
  --bg: #07090F;
  --surface: #0F1117;
  --card: #161B27;
  --card-hover: #1C2235;
  --border: #1E2740;
  --border-subtle: #151D30;
  --accent: #6C63FF;
  --accent-soft: rgba(108,99,255,0.12);
  --accent2: #FF6584;
  --accent3: #43E8B0;
  --gold: #F5C35A;
  --text: #EEF2FF;
  --text-secondary: #8896B3;
  --muted: #4A5568;
  --radius: 16px;
  --radius-sm: 10px;
  --radius-xs: 8px;
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.25);
  --glow: 0 0 24px rgba(108,99,255,0.18);
}

body {
  font-family: 'Outfit', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  min-height: 100dvh;
  overflow: hidden;
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
  -webkit-font-smoothing: antialiased;
}
* { -webkit-tap-highlight-color: transparent; }

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen { display:none; flex-direction:column; height:100vh; height:100dvh; background:var(--bg); }
.screen.active { display:flex; }

/* ‚îÄ‚îÄ STATUS BAR ‚îÄ‚îÄ */
.status-bar {
  padding: max(env(safe-area-inset-top),12px) 1.4rem 6px;
  display:flex; justify-content:space-between;
  font-size:0.7rem; font-weight:600; color:var(--text-secondary);
  background:var(--bg); flex-shrink:0; letter-spacing:0.02em;
}

/* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
.topbar {
  padding:0.7rem 1.4rem;
  display:flex; align-items:center; justify-content:space-between;
  background:var(--bg); border-bottom:1px solid var(--border-subtle);
  flex-shrink:0; gap:0.75rem;
}
.topbar-logo {
  font-size:1.25rem; font-weight:800; letter-spacing:-0.02em;
  background:linear-gradient(135deg,#8B83FF,#FF6584);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
.topbar-title { font-size:1.05rem; font-weight:700; color:var(--text); }
.back-btn {
  background:none; border:none; color:var(--accent);
  font-family:'Outfit',sans-serif; font-size:0.88rem; cursor:pointer;
  padding:0; display:flex; align-items:center; gap:0.25rem;
  font-weight:500; flex-shrink:0;
}

/* ‚îÄ‚îÄ SCROLL AREA ‚îÄ‚îÄ */
.scroll-area { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:1rem 1.4rem; }
.scroll-area::-webkit-scrollbar { width:2px; }
.scroll-area::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.bottom-nav {
  display:flex; background:var(--surface);
  border-top:1px solid var(--border-subtle);
  padding:0.5rem 0 max(env(safe-area-inset-bottom),0.65rem);
  flex-shrink:0;
}
.nav-item {
  flex:1; display:flex; flex-direction:column; align-items:center; gap:0.15rem;
  cursor:pointer; font-size:0.58rem; color:var(--muted);
  background:none; border:none; font-family:'Outfit',sans-serif;
  transition:color 0.2s; padding:0.25rem 0; font-weight:500; letter-spacing:0.02em;
}
.nav-item.active { color:var(--accent); }
.nav-icon { font-size:1.2rem; line-height:1; }

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card {
  background:var(--card); border-radius:var(--radius);
  padding:1rem 1.1rem; margin-bottom:0.65rem;
  border:1px solid var(--border-subtle); cursor:pointer;
  transition:border-color 0.2s, transform 0.12s, background 0.15s;
}
.card:active { transform:scale(0.985); background:var(--card-hover); }
.card:hover { border-color:var(--border); }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn-primary {
  width:100%; padding:0.95rem;
  background:linear-gradient(135deg,#6C63FF,#8B83FF);
  border:none; border-radius:var(--radius); color:white;
  font-family:'Outfit',sans-serif; font-size:0.95rem; font-weight:700;
  cursor:pointer; margin-bottom:0.75rem;
  transition:opacity 0.2s, transform 0.12s;
  box-shadow:0 4px 16px rgba(108,99,255,0.3);
  letter-spacing:0.01em;
}
.btn-primary:active { transform:scale(0.98); opacity:0.9; }

.btn-secondary {
  width:100%; padding:0.9rem;
  background:transparent; border:1px solid var(--border);
  border-radius:var(--radius); color:var(--text-secondary);
  font-family:'Outfit',sans-serif; font-size:0.9rem; cursor:pointer; margin-bottom:0.75rem;
  transition:border-color 0.2s, color 0.2s;
}
.btn-secondary:hover { border-color:var(--accent); color:var(--text); }

.btn-sm {
  padding:0.45rem 0.9rem; border-radius:var(--radius-sm); border:none;
  font-family:'Outfit',sans-serif; font-size:0.78rem; font-weight:600; cursor:pointer;
  transition:opacity 0.15s, transform 0.12s;
}
.btn-sm:active { transform:scale(0.96); }
.btn-accent { background:linear-gradient(135deg,#6C63FF,#8B83FF); color:white; box-shadow:0 2px 10px rgba(108,99,255,0.25); }
.btn-ghost { background:var(--card); border:1px solid var(--border); color:var(--text-secondary); }
.btn-ghost:hover { border-color:var(--border); color:var(--text); }

/* ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ */
.input-group { margin-bottom:1rem; }
.input-label { font-size:0.7rem; color:var(--text-secondary); margin-bottom:0.45rem; text-transform:uppercase; letter-spacing:0.1em; font-weight:600; }
.input {
  width:100%; padding:0.8rem 1rem;
  background:var(--card); border:1px solid var(--border);
  border-radius:var(--radius-sm); color:var(--text);
  font-family:'Outfit',sans-serif; font-size:0.9rem;
  outline:none; transition:border-color 0.2s, box-shadow 0.2s;
}
.input:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(108,99,255,0.12); }
.input::placeholder { color:var(--muted); }
textarea.input { resize:none; min-height:80px; }
select.input { appearance:none; }

/* ‚îÄ‚îÄ TAGS ‚îÄ‚îÄ */
.tag {
  display:inline-block; font-size:0.7rem; padding:0.22rem 0.6rem;
  border-radius:99px; background:var(--accent-soft);
  color:var(--accent); border:1px solid rgba(108,99,255,0.2);
  margin:0.2rem 0.2rem 0.2rem 0;
}
.tag.active-tag { background:var(--accent); color:white; border-color:var(--accent); }
.tag.mint { background:rgba(67,232,176,0.1); color:var(--accent3); border-color:rgba(67,232,176,0.2); }
.tag.pink { background:rgba(255,101,132,0.1); color:var(--accent2); border-color:rgba(255,101,132,0.2); }
.tag.gold { background:rgba(245,195,90,0.1); color:var(--gold); border-color:rgba(245,195,90,0.2); }

/* ‚îÄ‚îÄ AVATAR ‚îÄ‚îÄ */
.avatar {
  width:42px; height:42px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:0.9rem; font-weight:700; color:white; flex-shrink:0;
}
.avatar-lg { width:72px; height:72px; font-size:1.6rem; font-weight:800; }

/* ‚îÄ‚îÄ MATCH BAR ‚îÄ‚îÄ */
.match-bar-wrap { height:3px; background:var(--border); border-radius:99px; overflow:hidden; margin-top:0.35rem; }
.match-bar { height:100%; border-radius:99px; background:linear-gradient(90deg,var(--accent3),var(--accent)); }

/* ‚îÄ‚îÄ SECTION LABEL ‚îÄ‚îÄ */
.section-label {
  font-size:0.62rem; font-weight:700; letter-spacing:0.12em; text-transform:uppercase;
  color:var(--muted); margin:1.25rem 0 0.65rem;
}
.section-label:first-child { margin-top:0; }

/* ‚îÄ‚îÄ STAT BOX ‚îÄ‚îÄ */
.stat-box { flex:1; background:var(--card); border-radius:var(--radius-sm); padding:0.7rem; text-align:center; border:1px solid var(--border-subtle); }
.stat-num { font-size:1.35rem; font-weight:800; }
.stat-label { font-size:0.6rem; color:var(--text-secondary); margin-top:0.1rem; }

/* ‚îÄ‚îÄ LIVE DOT ‚îÄ‚îÄ */
.live-dot { width:7px; height:7px; border-radius:50%; background:var(--accent3); animation:pulse 2s infinite; flex-shrink:0; }
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.35;transform:scale(0.65)} }

/* ‚îÄ‚îÄ RADAR CARD ‚îÄ‚îÄ */
.radar-card {
  background:var(--surface); border-radius:var(--radius); padding:1.1rem 1.2rem;
  margin-bottom:1rem; border:1px solid var(--border-subtle); position:relative; overflow:hidden;
}
.radar-card::before {
  content:''; position:absolute; top:-30px; right:-30px;
  width:110px; height:110px; border-radius:50%;
  background:radial-gradient(circle,rgba(108,99,255,0.12),transparent 70%);
  pointer-events:none;
}

/* ‚îÄ‚îÄ BUBBLE ICON ‚îÄ‚îÄ */
.bubble-icon { width:42px; height:42px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.2rem; flex-shrink:0; }

/* ‚îÄ‚îÄ MODAL / OVERLAY ‚îÄ‚îÄ */
.modal-overlay {
  display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7);
  z-index:100; align-items:flex-end; justify-content:center;
  backdrop-filter:blur(6px);
}
.modal-overlay.open { display:flex; }
.modal-sheet {
  background:var(--surface); border-radius:24px 24px 0 0;
  border-top:1px solid var(--border);
  padding:1.5rem 1.4rem max(env(safe-area-inset-bottom),1.5rem);
  width:100%; max-height:88vh; overflow-y:auto;
}
.modal-handle { width:36px; height:4px; background:var(--border); border-radius:99px; margin:0 auto 1.25rem; }
.modal-title { font-size:1.15rem; font-weight:800; margin-bottom:1.25rem; letter-spacing:-0.01em; }
.modal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1.25rem; }
.modal-close { background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:1.1rem; padding:0; }
.modal { display:none; position:fixed; inset:0; z-index:150; background:rgba(0,0,0,0.7); backdrop-filter:blur(6px); align-items:flex-end; }
.modal.open { display:flex; }
.modal-content { background:var(--surface); border-radius:24px 24px 0 0; border-top:1px solid var(--border); width:100%; max-height:88vh; overflow-y:auto; }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast {
  position:fixed; bottom:calc(env(safe-area-inset-bottom) + 76px); left:50%;
  transform:translateX(-50%) translateY(12px);
  background:var(--card); color:var(--text);
  border:1px solid var(--border);
  padding:0.65rem 1.4rem;
  border-radius:99px; font-size:0.82rem; font-weight:600;
  opacity:0; transition:all 0.28s cubic-bezier(0.32,0.72,0,1);
  z-index:300; white-space:nowrap;
  box-shadow:0 8px 32px rgba(0,0,0,0.5);
}
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* ‚îÄ‚îÄ SPINNER ‚îÄ‚îÄ */
.spinner {
  width:32px; height:32px;
  border:2px solid var(--border); border-top-color:var(--accent);
  border-radius:50%; animation:spin 0.75s linear infinite; margin:2.5rem auto;
}
@keyframes spin { to { transform:rotate(360deg); } }

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty-state { text-align:center; padding:3rem 1rem; color:var(--text-secondary); }
.empty-icon { font-size:2.2rem; margin-bottom:0.65rem; opacity:0.6; }
.empty-text { font-size:0.88rem; line-height:1.6; }

/* ‚îÄ‚îÄ DM CHAT ‚îÄ‚îÄ */
.msg-bubble {
  max-width:78%; padding:0.65rem 0.95rem;
  border-radius:18px; margin-bottom:0.5rem;
  font-size:0.875rem; line-height:1.45;
}
.msg-bubble.sent { background:linear-gradient(135deg,var(--accent),#8B83FF); color:white; margin-left:auto; border-bottom-right-radius:4px; }
.msg-bubble.recv { background:var(--card); border:1px solid var(--border-subtle); color:var(--text); border-bottom-left-radius:4px; }
.msg-time { font-size:0.6rem; color:var(--muted); margin-top:0.2rem; }

/* ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ */
#screen-auth {
  align-items:center; justify-content:center;
  background:radial-gradient(ellipse at 50% 20%, rgba(108,99,255,0.18) 0%, transparent 60%), var(--bg);
  padding:2rem 1.4rem;
}

/* ‚îÄ‚îÄ LOADING SCREEN ‚îÄ‚îÄ */
#screen-loading { align-items:center; justify-content:center; background:var(--bg); }

/* ‚îÄ‚îÄ KEYWORD CHIPS INPUT ‚îÄ‚îÄ */
.chips-container {
  display:flex; flex-wrap:wrap; gap:0.4rem; padding:0.75rem;
  background:var(--card); border:1px solid var(--border);
  border-radius:var(--radius-sm); min-height:48px; cursor:text;
}
.chip { background:var(--accent); color:white; border-radius:99px; padding:0.22rem 0.55rem; font-size:0.75rem; display:flex; align-items:center; gap:0.3rem; }
.chip-remove { cursor:pointer; opacity:0.7; font-size:0.85rem; }
.chip-input { background:none; border:none; color:var(--text); font-family:'Outfit',sans-serif; font-size:0.88rem; outline:none; min-width:80px; flex:1; }

/* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
.notif-dot { width:8px; height:8px; border-radius:50%; background:var(--accent2); position:absolute; top:0; right:-2px; }
.msg-unread-badge {
  position:absolute; top:-6px; right:-6px;
  min-width:17px; height:17px; background:var(--accent2); color:#fff;
  border-radius:9px; font-size:0.6rem; font-weight:700;
  display:flex; align-items:center; justify-content:center; padding:0 3px;
  pointer-events:none; border:1.5px solid var(--bg);
}

/* ‚îÄ‚îÄ PROFILE HERO ‚îÄ‚îÄ */
.profile-hero {
  padding:1.75rem 1.4rem 1.4rem; text-align:center;
  background:linear-gradient(180deg, rgba(108,99,255,0.1) 0%, transparent 100%);
  border-bottom:1px solid var(--border-subtle);
}

/* ‚îÄ‚îÄ PERSON PROFILE ‚îÄ‚îÄ */
.person-cover { height:140px; position:relative; overflow:hidden; flex-shrink:0; }
.person-cover-gradient { position:absolute; inset:0; background:linear-gradient(135deg,#6C63FF,#FF6584); }
.person-cover-pattern {
  position:absolute; inset:0; opacity:0.12;
  background-image:radial-gradient(circle at 20% 80%,white 1px,transparent 1px),
    radial-gradient(circle at 80% 20%,white 1px,transparent 1px);
  background-size:32px 32px, 40px 40px;
}
.person-avatar-wrap { position:relative; display:inline-block; margin-top:-42px; z-index:2; }
.person-avatar-ring {
  width:84px; height:84px; border-radius:50%;
  border:3px solid var(--bg);
  background:linear-gradient(135deg,#6C63FF,#FF6584);
  display:flex; align-items:center; justify-content:center;
  font-size:1.85rem; font-weight:800; color:white;
  box-shadow:0 4px 20px rgba(0,0,0,0.4);
}
.person-info-section { padding:0.75rem 1.4rem 1rem; text-align:center; }
.person-display-name { font-size:1.3rem; font-weight:800; margin-bottom:0.2rem; color:var(--text); letter-spacing:-0.01em; }
.person-display-title { font-size:0.82rem; color:var(--text-secondary); margin-bottom:0.55rem; }
.person-action-bar { display:flex; gap:0.45rem; padding:0 1.4rem 1.1rem; border-bottom:1px solid var(--border-subtle); }
.person-action-btn {
  flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:0.3rem; padding:0.7rem 0.2rem; border-radius:var(--radius-sm);
  border:1px solid var(--border); background:var(--card);
  cursor:pointer; font-family:inherit; transition:all 0.15s;
  font-size:0.68rem; color:var(--text-secondary); font-weight:600;
}
.person-action-btn:active { transform:scale(0.95); background:var(--card-hover); }
.person-action-btn .btn-icon { font-size:1.05rem; line-height:1; }
.person-action-btn.primary { background:var(--accent); border-color:var(--accent); color:white; box-shadow:0 2px 12px rgba(108,99,255,0.3); }
.person-action-btn.linkedin { border-color:rgba(10,102,194,0.4); color:#4A9FD4; }
.person-section { padding:1rem 1.4rem; border-bottom:1px solid var(--border-subtle); }
.person-section:last-child { border-bottom:none; }
.person-section-title { font-size:0.68rem; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:0.1em; margin-bottom:0.6rem; }
.person-bio-text { font-size:0.875rem; color:var(--text); line-height:1.65; }

/* ‚îÄ‚îÄ HOME NAV CARDS ‚îÄ‚îÄ */
.main-nav-card {
  border-radius:var(--radius); padding:1.05rem 1.15rem;
  display:flex; align-items:center; gap:1rem; cursor:pointer;
  transition:transform 0.12s, border-color 0.15s;
}
.main-nav-card:active { transform:scale(0.985); }
.card-bobler   { background:linear-gradient(135deg,rgba(108,99,255,0.1),rgba(108,99,255,0.04)); border:1px solid rgba(108,99,255,0.18); }
.card-beskeder { background:linear-gradient(135deg,rgba(255,101,132,0.1),rgba(255,101,132,0.04)); border:1px solid rgba(255,101,132,0.18); }
.card-notif    { background:linear-gradient(135deg,rgba(67,232,176,0.1),rgba(67,232,176,0.04)); border:1px solid rgba(67,232,176,0.18); }
.main-nav-icon { width:48px; height:48px; border-radius:13px; display:flex; align-items:center; justify-content:center; font-size:1.65rem; flex-shrink:0; }
.main-nav-badge { min-width:24px; height:24px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:0.7rem; font-weight:700; padding:0 6px; flex-shrink:0; }
.badge-bobler   { background:rgba(108,99,255,0.25); color:#A09AFF; }
.badge-beskeder { background:rgba(255,101,132,0.25); color:#FF8FA3; }
.badge-notif    { background:rgba(67,232,176,0.25); color:#43E8B0; }

/* ‚îÄ‚îÄ DM INPUT ‚îÄ‚îÄ */
.thread-input-row {
  display:flex; gap:0.5rem;
  padding:0.65rem 1.4rem max(env(safe-area-inset-bottom),0.65rem);
  background:var(--surface); border-top:1px solid var(--border-subtle); flex-shrink:0;
}
.thread-input {
  flex:1; padding:0.6rem 1rem; background:var(--card);
  border:1px solid var(--border); border-radius:99px; color:var(--text);
  font-family:'Outfit',sans-serif; font-size:0.875rem; outline:none;
  transition:border-color 0.15s;
}
.thread-input:focus { border-color:var(--accent); }
.send-btn {
  width:38px; height:38px; border-radius:50%;
  background:linear-gradient(135deg,var(--accent),#8B83FF);
  border:none; color:white; font-size:1rem; cursor:pointer;
  display:flex; align-items:center; justify-content:center; flex-shrink:0;
}

/* ‚îÄ‚îÄ THEME DROPDOWN ‚îÄ‚îÄ */
.theme-option {
  display:flex; align-items:center; gap:0.75rem;
  padding:0.62rem 1rem; cursor:pointer; font-size:0.85rem;
  color:var(--text); border-bottom:1px solid var(--border-subtle);
  transition:background 0.1s;
}
.theme-option:last-child { border-bottom:none; }
.theme-option:hover, .theme-option.active { background:var(--card-hover); }
.theme-option.active { font-weight:700; }
.theme-opt-swatch { width:26px; height:26px; border-radius:7px; flex-shrink:0; }


/* ‚ïê‚ïê THEMES ‚ïê‚ïê */
body[data-theme="arctic"] {
  --bg:#F8F9FB; --bg2:#FFFFFF; --card:#FFFFFF; --card2:#EEF1F5;
  --border:#E2E6ED; --text:#0D1117; --text2:#3D4A5C; --muted:#8A96A8;
  --accent:#2563EB; --accent2:#DC2626; --accent-bg:#EFF6FF;
  --green:#059669; --green-bg:#ECFDF5;
  --nav-bg:#FFFFFF; --topbar-bg:#FFFFFF;
  --shadow:0 1px 3px rgba(0,0,0,0.07),0 4px 12px rgba(0,0,0,0.05);
  --shadow-sm:0 1px 2px rgba(0,0,0,0.05);
  --radius:12px; --radius-sm:8px;
  --score-bg:#EFF6FF; --score-color:#2563EB;
  --tag-bg:#EEF1F5; --tag-color:#3D4A5C;
  --active-dot:#059669;
  --font:'DM Sans',sans-serif;
  --logo-color:#2563EB;
  --accent-gradient:linear-gradient(135deg,#2563EB,#3B82F6);
}

/* 2. MIDNIGHT ‚Äî M√∏rk, elegant, premium */
body[data-theme="midnight"] {
  --bg:#0A0E1A; --bg2:#111827; --card:#151C2C; --card2:#1C2537;
  --border:#1E2D45; --text:#F0F4FF; --text2:#A8B8D0; --muted:#5A7090;
  --accent:#60A5FA; --accent2:#F472B6; --accent-bg:#172035;
  --green:#34D399; --green-bg:#064231;
  --nav-bg:#111827; --topbar-bg:#0D1220;
  --shadow:0 2px 8px rgba(0,0,0,0.4),0 0 0 1px rgba(255,255,255,0.04);
  --shadow-sm:0 1px 3px rgba(0,0,0,0.3);
  --radius:14px; --radius-sm:9px;
  --score-bg:#172035; --score-color:#60A5FA;
  --tag-bg:#1C2537; --tag-color:#A8B8D0;
  --active-dot:#34D399;
  --font:'Sora',sans-serif;
  --logo-color:#60A5FA;
  --accent-gradient:linear-gradient(135deg,#3B82F6,#8B5CF6);
}

/* 3. FOREST ‚Äî Naturlig, varm, organisk */
body[data-theme="forest"] {
  --bg:#F2F5F0; --bg2:#FAFCF8; --card:#FFFFFF; --card2:#E8EDE4;
  --border:#D4DBCC; --text:#1A2214; --text2:#3D5030; --muted:#7A906A;
  --accent:#2D6A4F; --accent2:#B5451B; --accent-bg:#D8F3DC;
  --green:#1B7A4A; --green-bg:#DCFCE7;
  --nav-bg:#FAFCF8; --topbar-bg:#FAFCF8;
  --shadow:0 1px 3px rgba(45,106,79,0.08),0 4px 12px rgba(0,0,0,0.05);
  --shadow-sm:0 1px 2px rgba(0,0,0,0.04);
  --radius:10px; --radius-sm:6px;
  --score-bg:#D8F3DC; --score-color:#2D6A4F;
  --tag-bg:#E8EDE4; --tag-color:#3D5030;
  --active-dot:#1B7A4A;
  --font:'DM Sans',sans-serif;
  --logo-color:#2D6A4F;
  --accent-gradient:linear-gradient(135deg,#2D6A4F,#40916C);
}

/* 4. CORAL ‚Äî Varm, energisk, venlig */
body[data-theme="coral"] {
  --bg:#FFF8F6; --bg2:#FFFFFF; --card:#FFFFFF; --card2:#FDE8E2;
  --border:#F5C9BE; --text:#2D1410; --text2:#6B3020; --muted:#C08070;
  --accent:#E8450A; --accent2:#0891B2; --accent-bg:#FDE8E2;
  --green:#059669; --green-bg:#ECFDF5;
  --nav-bg:#FFFFFF; --topbar-bg:#FFFFFF;
  --shadow:0 1px 3px rgba(232,69,10,0.08),0 4px 12px rgba(0,0,0,0.06);
  --shadow-sm:0 1px 2px rgba(0,0,0,0.05);
  --radius:16px; --radius-sm:10px;
  --score-bg:#FDE8E2; --score-color:#E8450A;
  --tag-bg:#FDE8E2; --tag-color:#6B3020;
  --active-dot:#059669;
  --font:'Space Grotesk',sans-serif;
  --logo-color:#E8450A;
  --accent-gradient:linear-gradient(135deg,#E8450A,#F97316);
}

/* 5. SLATE ‚Äî Neutral, seri√∏s, enterprise */
body[data-theme="slate"] {
  --bg:#F1F3F6; --bg2:#FFFFFF; --card:#FFFFFF; --card2:#E5E9EF;
  --border:#D0D5DE; --text:#111827; --text2:#374151; --muted:#9CA3AF;
  --accent:#374151; --accent2:#6366F1; --accent-bg:#F3F4F6;
  --green:#059669; --green-bg:#ECFDF5;
  --nav-bg:#FFFFFF; --topbar-bg:#FFFFFF;
  --shadow:0 1px 2px rgba(0,0,0,0.06),0 3px 8px rgba(0,0,0,0.04);
  --shadow-sm:0 1px 2px rgba(0,0,0,0.04);
  --radius:8px; --radius-sm:5px;
  --score-bg:#F3F4F6; --score-color:#374151;
  --tag-bg:#E5E9EF; --tag-color:#374151;
  --active-dot:#059669;
  --font:'Space Grotesk',sans-serif;
  --logo-color:#111827;
  --accent-gradient:linear-gradient(135deg,#374151,#4B5563);
}

/* 6. VIOLET ‚Äî Moderne, kreativ, tech */
body[data-theme="violet"] {
  --bg:#F5F3FF; --bg2:#FFFFFF; --card:#FFFFFF; --card2:#EDE9FE;
  --border:#DDD6FE; --text:#1E1B4B; --text2:#4338CA; --muted:#8B5CF6;
  --accent:#7C3AED; --accent2:#DB2777; --accent-bg:#EDE9FE;
  --green:#059669; --green-bg:#ECFDF5;
  --nav-bg:#FFFFFF; --topbar-bg:#FFFFFF;
  --shadow:0 1px 3px rgba(124,58,237,0.1),0 4px 12px rgba(124,58,237,0.07);
  --shadow-sm:0 1px 2px rgba(124,58,237,0.06);
  --radius:14px; --radius-sm:9px;
  --score-bg:#EDE9FE; --score-color:#7C3AED;
  --tag-bg:#EDE9FE; --tag-color:#4338CA;
  --active-dot:#059669;
  --font:'Sora',sans-serif;
  --logo-color:#7C3AED;
  --accent-gradient:linear-gradient(135deg,#7C3AED,#A855F7);
}

/* 7. OCEAN ‚Äî Dyb, frisk, rolig */
body[data-theme="ocean"] {
  --bg:#EBF4FC; --bg2:#FFFFFF; --card:#FFFFFF; --card2:#DBEAFE;
  --border:#BFDBFE; --text:#0C2340; --text2:#1E4D7B; --muted:#60A0C8;
  --accent:#0066CC; --accent2:#0891B2; --accent-bg:#DBEAFE;
  --green:#0891B2; --green-bg:#CFFAFE;
  --nav-bg:#FFFFFF; --topbar-bg:#FFFFFF;
  --shadow:0 1px 3px rgba(0,102,204,0.08),0 4px 12px rgba(0,102,204,0.07);
  --shadow-sm:0 1px 2px rgba(0,102,204,0.05);
  --radius:14px; --radius-sm:9px;
  --score-bg:#DBEAFE; --score-color:#0066CC;
  --tag-bg:#DBEAFE; --tag-color:#1E4D7B;
  --active-dot:#0891B2;
  --font:'DM Sans',sans-serif;
  --logo-color:#0066CC;
  --accent-gradient:linear-gradient(135deg,#0066CC,#0EA5E9);
}

/* 8. NOIR ‚Äî Dramatisk, high-contrast, eksklusiv */
body[data-theme="noir"] {
  --bg:#0C0C0C; --bg2:#141414; --card:#1A1A1A; --card2:#222222;
  --border:#2A2A2A; --text:#F5F5F5; --text2:#C0C0C0; --muted:#666666;
  --accent:#FFFFFF; --accent2:#FFD700; --accent-bg:#252525;
  --green:#50C878; --green-bg:#0A2A15;
  --nav-bg:#141414; --topbar-bg:#0C0C0C;
  --shadow:0 2px 8px rgba(0,0,0,0.6),0 0 0 1px rgba(255,255,255,0.05);
  --shadow-sm:0 1px 3px rgba(0,0,0,0.5);
  --radius:6px; --radius-sm:4px;
  --score-bg:#252525; --score-color:#FFFFFF;
  --tag-bg:#222222; --tag-color:#C0C0C0;
  --active-dot:#50C878;
  --font:'DM Mono',monospace;
  --logo-color:#FFFFFF;
  --accent-gradient:linear-gradient(135deg,#333,#555);
}

/* 9. SUNSET ‚Äî Lekker, varm gradient, social */
body[data-theme="sunset"] {
  --bg:#FFF7F0; --bg2:#FFFFFF; --card:#FFFFFF; --card2:#FEE8D5;
  --border:#FBD0AC; --text:#2C1A0E; --text2:#7B3A10; --muted:#C2845A;
  --accent:#EA580C; --accent2:#9333EA; --accent-bg:#FEE8D5;
  --green:#16A34A; --green-bg:#DCFCE7;
  --nav-bg:#FFFFFF; --topbar-bg:#FFFFFF;
  --shadow:0 1px 3px rgba(234,88,12,0.08),0 4px 12px rgba(0,0,0,0.06);
  --shadow-sm:0 1px 2px rgba(0,0,0,0.04);
  --radius:18px; --radius-sm:11px;
  --score-bg:#FEE8D5; --score-color:#EA580C;
  --tag-bg:#FEE8D5; --tag-color:#7B3A10;
  --active-dot:#16A34A;
  --font:'Sora',sans-serif;
  --logo-color:#EA580C;
  --accent-gradient:linear-gradient(135deg,#EA580C,#F97316,#FBBF24);
}

/* 10. NORDIC ‚Äî Skandinavisk, minimalt, tillidsfuldt */
body[data-theme="nordic"] {
  --bg:#F5F0EB; --bg2:#FDFAF7; --card:#FDFAF7; --card2:#EDE5DC;
  --border:#D8CDBF; --text:#1C1612; --text2:#4A3D30; --muted:#9A8A78;
  --accent:#4A3D30; --accent2:#C0392B; --accent-bg:#EDE5DC;
  --green:#27AE60; --green-bg:#D5F5E3;
  --nav-bg:#FDFAF7; --topbar-bg:#FDFAF7;
  --shadow:0 1px 3px rgba(0,0,0,0.06),0 4px 10px rgba(0,0,0,0.04);
  --shadow-sm:0 1px 2px rgba(0,0,0,0.04);
  --radius:8px; --radius-sm:5px;
  --score-bg:#EDE5DC; --score-color:#4A3D30;
  --tag-bg:#EDE5DC; --tag-color:#4A3D30;
  --active-dot:#27AE60;
  --font:'DM Sans',sans-serif;
  --logo-color:#4A3D30;
  --accent-gradient:linear-gradient(135deg,#4A3D30,#6B5744);
}

/* 11. NEON ‚Äî Bold, ungdommelig, gaming-ish */
body[data-theme="neon"] {
  --bg:#06040F; --bg2:#0D0820; --card:#120D25; --card2:#1A1235;
  --border:#2A1F50; --text:#F0EAFF; --text2:#C8BAFF; --muted:#6B5EA0;
  --accent:#A855F7; --accent2:#22D3EE; --accent-bg:#1E1040;
  --green:#22D3EE; --green-bg:#0A2030;
  --nav-bg:#0D0820; --topbar-bg:#06040F;
  --shadow:0 0 20px rgba(168,85,247,0.15),0 2px 8px rgba(0,0,0,0.5);
  --shadow-sm:0 0 8px rgba(168,85,247,0.1);
  --radius:16px; --radius-sm:10px;
  --score-bg:#1E1040; --score-color:#A855F7;
  --tag-bg:#1A1235; --tag-color:#C8BAFF;
  --active-dot:#22D3EE;
  --font:'Space Grotesk',sans-serif;
  --logo-color:#A855F7;
  --accent-gradient:linear-gradient(135deg,#A855F7,#EC4899);
}

/* 12. SAND ‚Äî Rolig, neutral, tidl√∏s */
body[data-theme="sand"] {
  --bg:#FAF7F2; --bg2:#FFFFFF; --card:#FFFFFF; --card2:#F0EAE0;
  --border:#E0D8CC; --text:#1A1510; --text2:#4A4035; --muted:#9A9080;
  --accent:#B8860B; --accent2:#8B4513; --accent-bg:#FDF5E0;
  --green:#2E7D32; --green-bg:#E8F5E9;
  --nav-bg:#FFFFFF; --topbar-bg:#FFFFFF;
  --shadow:0 1px 3px rgba(0,0,0,0.06),0 4px 10px rgba(0,0,0,0.04);
  --shadow-sm:0 1px 2px rgba(0,0,0,0.04);
  --radius:10px; --radius-sm:6px;
  --score-bg:#FDF5E0; --score-color:#B8860B;
  --tag-bg:#F0EAE0; --tag-color:#4A4035;
  --active-dot:#2E7D32;
  --font:'DM Sans',sans-serif;
  --logo-color:#B8860B;
  --accent-gradient:linear-gradient(135deg,#B8860B,#DAA520);
}

/* 13. ROSE ‚Äî Feminin, bl√∏d, moderne */
body[data-theme="rose"] {
  --bg:#FFF5F7; --bg2:#FFFFFF; --card:#FFFFFF; --card2:#FFE4EC;
  --border:#FFCCD8; --text:#2D0F18; --text2:#7D2040; --muted:#C07090;
  --accent:#BE185D; --accent2:#7C3AED; --accent-bg:#FFE4EC;
  --green:#059669; --green-bg:#ECFDF5;
  --nav-bg:#FFFFFF; --topbar-bg:#FFFFFF;
  --shadow:0 1px 3px rgba(190,24,93,0.08),0 4px 12px rgba(0,0,0,0.05);
  --shadow-sm:0 1px 2px rgba(190,24,93,0.05);
  --radius:20px; --radius-sm:12px;
  --score-bg:#FFE4EC; --score-color:#BE185D;
  --tag-bg:#FFE4EC; --tag-color:#7D2040;
  --active-dot:#059669;
  --font:'Sora',sans-serif;
  --logo-color:#BE185D;
  --accent-gradient:linear-gradient(135deg,#BE185D,#DB2777);
}

/* 14. DEEP SEA ‚Äî M√∏rk, bl√•, seri√∏s */
body[data-theme="deepsea"] {
  --bg:#050E1A; --bg2:#091525; --card:#0D1E30; --card2:#122540;
  --border:#1A3050; --text:#E8F4FF; --text2:#90B8D8; --muted:#3A6080;
  --accent:#38BDF8; --accent2:#34D399; --accent-bg:#0D2035;
  --green:#34D399; --green-bg:#042820;
  --nav-bg:#091525; --topbar-bg:#050E1A;
  --shadow:0 2px 8px rgba(0,0,0,0.4),0 0 0 1px rgba(56,189,248,0.08);
  --shadow-sm:0 1px 3px rgba(0,0,0,0.3);
  --radius:12px; --radius-sm:7px;
  --score-bg:#0D2035; --score-color:#38BDF8;
  --tag-bg:#122540; --tag-color:#90B8D8;
  --active-dot:#34D399;
  --font:'Space Grotesk',sans-serif;
  --logo-color:#38BDF8;
  --accent-gradient:linear-gradient(135deg,#0369A1,#38BDF8);
}

/* 15. EDITORIAL ‚Äî Avis-agtig, seri√∏s, tillid */
body[data-theme="editorial"] {
  --bg:#FFFEF9; --bg2:#FFFFFF; --card:#FFFFFF; --card2:#F5F0E8;
  --border:#E0D8C8; --text:#0A0A08; --text2:#2A2A22; --muted:#888878;
  --accent:#1A1A14; --accent2:#C0392B; --accent-bg:#F5F0E8;
  --green:#2D7A3A; --green-bg:#E8F5E9;
  --nav-bg:#FFFFFF; --topbar-bg:#FFFEF9;
  --shadow:0 1px 2px rgba(0,0,0,0.05),0 3px 8px rgba(0,0,0,0.04);
  --shadow-sm:0 1px 1px rgba(0,0,0,0.04);
  --radius:4px; --radius-sm:3px;
  --score-bg:#F5F0E8; --score-color:#1A1A14;
  --tag-bg:#F5F0E8; --tag-color:#2A2A22;
  --active-dot:#2D7A3A;
  --font:'Playfair Display',serif;
  --logo-color:#0A0A08;
  --accent-gradient:linear-gradient(135deg,#1A1A14,#333328);
}



/* ‚ïê‚ïê THEME DROPDOWN ‚ïê‚ïê */
.theme-option {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.65rem 1rem;
  cursor: pointer;
  font-size: 0.88rem;
  color: var(--text);
  border-bottom: 1px solid var(--border);
  transition: background 0.1s;
}
.theme-option:last-child { border-bottom: none; }
.theme-option:hover, .theme-option.active { background: var(--card2); }
.theme-option.active { font-weight: 700; }
.theme-opt-swatch {
  width: 28px;
  height: 28px;
  border-radius: 7px;
  flex-shrink: 0;
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BOBLE CHAT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.bubble-tabs { display:flex; margin:0.75rem 1.25rem 0; background:var(--surface); border-radius:12px; padding:3px; gap:2px; flex-shrink:0; }
.bubble-tab { flex:1; text-align:center; padding:0.45rem 0.2rem; border-radius:10px; font-size:0.75rem; font-weight:600; cursor:pointer; color:var(--muted); transition:all 0.2s; user-select:none; font-family:'Outfit',sans-serif; border:none; background:none; }
.bubble-tab.active { background:var(--card); color:var(--accent); }
.bubble-tab-badge { display:inline-flex; align-items:center; justify-content:center; width:14px; height:14px; background:#EF4444; border-radius:50%; font-size:0.55rem; font-weight:700; color:white; margin-left:0.3rem; vertical-align:middle; position:relative; top:-1px; }
.chat-messages { flex:1; overflow-y:auto; padding:0.75rem 1.25rem; display:flex; flex-direction:column; gap:0.65rem; -webkit-overflow-scrolling:touch; }
.chat-messages::-webkit-scrollbar { width:2px; }
.chat-date-sep { text-align:center; font-size:0.65rem; color:var(--muted); margin:0.3rem 0; position:relative; }
.chat-date-sep::before,.chat-date-sep::after { content:''; position:absolute; top:50%; width:calc(50% - 30px); height:1px; background:var(--border); }
.chat-date-sep::before{left:0} .chat-date-sep::after{right:0}
.chat-msg-group { display:flex; flex-direction:column; max-width:78%; }
.chat-msg-group.them { align-items:flex-start; }
.chat-msg-group.me { align-items:flex-end; align-self:flex-end; }
.chat-msg-avatar-row { display:flex; align-items:center; gap:0.4rem; margin-bottom:0.25rem; }
.chat-msg-group.me .chat-msg-avatar-row { flex-direction:row-reverse; }
.chat-msg-avatar { width:24px; height:24px; border-radius:50%; font-size:0.58rem; font-weight:700; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:transform 0.15s,box-shadow 0.15s; flex-shrink:0; }
.chat-msg-avatar:hover { transform:scale(1.15); box-shadow:0 0 0 2px rgba(108,99,255,0.4); }
.chat-msg-sender { font-size:0.62rem; color:var(--muted); font-weight:500; }
.chat-msg-wrap { display:flex; align-items:center; gap:0.3rem; }
.chat-msg-group.me .chat-msg-wrap { flex-direction:row-reverse; }
.chat-bubble { padding:0.5rem 0.85rem; border-radius:16px; font-size:0.85rem; line-height:1.45; position:relative; }
.chat-msg-group.them .chat-bubble { background:var(--card); color:var(--text); border-top-left-radius:4px; border:1px solid var(--border); }
.chat-msg-group.me .chat-bubble { background:linear-gradient(135deg,var(--accent),#8b83ff); color:white; border-top-right-radius:4px; }
.chat-reaction { position:absolute; bottom:-10px; font-size:0.68rem; background:var(--surface); border:1px solid var(--border); border-radius:20px; padding:0.05rem 0.35rem; cursor:pointer; white-space:nowrap; line-height:1.6; z-index:1; }
.chat-msg-group.them .chat-reaction { right:-4px; }
.chat-msg-group.me .chat-reaction { left:-4px; }
.chat-msg-actions { background:none; border:none; color:var(--border); font-size:0.85rem; cursor:pointer; padding:0.1rem 0.2rem; border-radius:6px; opacity:0; transition:opacity 0.15s; line-height:1; flex-shrink:0; }
.chat-msg-group:hover .chat-msg-actions { opacity:1; }
.chat-msg-actions:hover { color:var(--accent); }
.chat-msg-meta { display:flex; align-items:center; gap:0.3rem; margin-top:0.55rem; padding:0 0.2rem; }
.chat-msg-group.me .chat-msg-meta { justify-content:flex-end; }
.chat-msg-time { font-size:0.6rem; color:var(--muted); }
.chat-msg-edited { font-size:0.6rem; color:var(--muted); font-style:italic; cursor:pointer; }
.chat-msg-edited:hover { color:var(--accent); }
.chat-file-bubble { display:flex; align-items:center; gap:0.6rem; padding:0.6rem 0.85rem; border-radius:16px; font-size:0.82rem; cursor:pointer; transition:opacity 0.15s; }
.chat-file-bubble:hover { opacity:0.85; }
.chat-msg-group.them .chat-file-bubble { background:var(--card); border:1px solid var(--border); border-top-left-radius:4px; }
.chat-msg-group.me .chat-file-bubble { background:linear-gradient(135deg,var(--accent),#8b83ff); color:white; border-top-right-radius:4px; }
.chat-file-icon { font-size:1.3rem; flex-shrink:0; }
.chat-file-name { font-weight:600; font-size:0.78rem; }
.chat-file-size { font-size:0.65rem; opacity:0.7; }
.chat-typing { display:flex; align-items:center; gap:0.5rem; padding:0.2rem 0; }
.chat-typing-avatar { width:22px; height:22px; border-radius:50%; font-size:0.55rem; font-weight:700; display:flex; align-items:center; justify-content:center; }
.chat-typing-dots { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:0.4rem 0.7rem; display:flex; gap:0.25rem; align-items:center; }
.chat-typing-dot { width:5px; height:5px; background:var(--muted); border-radius:50%; animation:chatBounce 1.2s infinite; }
.chat-typing-dot:nth-child(2){animation-delay:0.2s}.chat-typing-dot:nth-child(3){animation-delay:0.4s}
@keyframes chatBounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-4px)}}
.chat-input-area { padding:0.65rem 1.25rem 0.75rem; border-top:1px solid var(--border); display:flex; gap:0.5rem; align-items:center; flex-shrink:0; background:var(--bg); position:relative; }
.chat-edit-bar { position:absolute; top:-30px; left:1.25rem; right:1.25rem; background:var(--card); border-left:2px solid var(--accent); padding:0.3rem 0.6rem; font-size:0.68rem; color:var(--accent); display:none; justify-content:space-between; align-items:center; border-radius:0 6px 6px 0; }
.chat-edit-bar.show { display:flex; }
.chat-input { flex:1; background:var(--card); border:1px solid var(--border); border-radius:20px; padding:0.5rem 0.9rem; color:var(--text); font-size:0.85rem; font-family:'Outfit',sans-serif; outline:none; transition:border-color 0.15s; }
.chat-input:focus { border-color:var(--accent); }
.chat-input::placeholder { color:var(--muted); }
.chat-send-btn { width:38px; height:38px; background:linear-gradient(135deg,var(--accent),#8b83ff); border:none; border-radius:50%; color:white; font-size:1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:transform 0.1s; flex-shrink:0; }
.chat-send-btn:active { transform:scale(0.92); }
.chat-file-btn { width:38px; height:38px; background:var(--card); border:1px solid var(--border); border-radius:50%; color:var(--muted); font-size:1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.chat-members-list { flex:1; overflow-y:auto; padding:0.75rem 1.25rem; -webkit-overflow-scrolling:touch; }
.chat-member-row { display:flex; align-items:center; gap:0.75rem; padding:0.6rem 0.75rem; border-radius:12px; cursor:pointer; transition:background 0.15s; }
.chat-member-row:hover { background:var(--card); }
.chat-member-avatar { width:36px; height:36px; border-radius:50%; font-size:0.7rem; font-weight:700; display:flex; align-items:center; justify-content:center; flex-shrink:0; position:relative; }
.chat-member-online { position:absolute; bottom:0; right:0; width:10px; height:10px; background:#22C55E; border-radius:50%; border:2px solid var(--bg); }
.chat-member-name { font-size:0.85rem; font-weight:600; color:var(--text); }
.chat-member-status { font-size:0.68rem; color:var(--muted); }
.chat-member-role { font-size:0.62rem; color:var(--accent); background:rgba(108,99,255,0.1); border-radius:20px; padding:0.1rem 0.45rem; }
.chat-section-label { font-size:0.62rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.08em; margin:0.5rem 0.75rem 0.4rem; font-weight:600; }
.chat-info-list { flex:1; overflow-y:auto; padding:0.75rem 1.25rem; display:flex; flex-direction:column; gap:0.75rem; -webkit-overflow-scrolling:touch; }
.chat-info-block { background:var(--card); border-radius:14px; padding:0.85rem 1rem; border:1px solid var(--border); }
.chat-info-label { font-size:0.62rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.08em; margin-bottom:0.4rem; font-weight:600; }
.chat-info-val { font-size:0.85rem; color:var(--text); line-height:1.5; }
.chat-info-btn { width:100%; padding:0.65rem 1rem; border-radius:12px; font-size:0.82rem; font-family:'Outfit',sans-serif; font-weight:600; cursor:pointer; border:none; text-align:left; transition:opacity 0.15s; margin-bottom:0.4rem; }
.chat-info-btn:hover { opacity:0.85; }
.chat-info-btn.primary { background:var(--card); color:var(--accent); border:1px solid var(--border); }
.chat-info-btn.danger { background:rgba(239,68,68,0.08); color:#F87171; }
.chat-context-menu { position:fixed; background:var(--card); border:1px solid var(--border); border-radius:14px; overflow:hidden; z-index:200; min-width:170px; display:none; box-shadow:0 8px 30px rgba(0,0,0,0.5); }
.chat-context-menu.open { display:block; }
.chat-context-item { padding:0.65rem 1rem; font-size:0.82rem; color:var(--text); cursor:pointer; transition:background 0.12s; display:flex; align-items:center; gap:0.5rem; font-family:'Outfit',sans-serif; }
.chat-context-item:hover { background:var(--surface); }
.chat-context-item.danger { color:#F87171; }
.chat-context-divider { height:1px; background:var(--border); }
.person-sheet-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.55); backdrop-filter:blur(5px); z-index:100; display:none; }
.person-sheet-overlay.open { display:block; }
.person-sheet { position:fixed; left:0; right:0; bottom:0; width:100%; background:var(--surface); border-radius:20px 20px 0 0; border-top:1px solid var(--border); z-index:101; transform:translateY(100%); transition:transform 0.32s cubic-bezier(0.32,0.72,0,1); padding:0 1.25rem 1.5rem; }
.person-sheet.open { transform:translateY(0); }
.person-sheet-handle { width:36px; height:4px; background:var(--border); border-radius:2px; margin:0.8rem auto 0.9rem; cursor:pointer; }
.person-sheet-header { display:flex; align-items:center; gap:0.9rem; margin-bottom:0.65rem; }
.person-sheet-avatar { width:46px; height:46px; border-radius:50%; font-size:0.88rem; font-weight:700; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.person-sheet-name { font-size:0.95rem; font-weight:700; }
.person-sheet-sub { font-size:0.68rem; color:var(--muted); margin-top:0.1rem; }
.person-sheet-close { margin-left:auto; background:none; border:none; color:var(--muted); cursor:pointer; font-size:1.1rem; padding:0; }
.person-sheet-bio { font-size:0.8rem; color:var(--muted); line-height:1.5; margin-bottom:0.9rem; }
.person-sheet-actions { display:flex; gap:0.4rem; margin-bottom:0.65rem; }
.person-sheet-btn { flex:1; padding:0.5rem 0.2rem; border-radius:10px; font-size:0.72rem; font-family:'Outfit',sans-serif; font-weight:600; cursor:pointer; border:none; text-align:center; }
.person-sheet-btn.primary { background:var(--card); color:var(--accent); border:1px solid var(--border); }
.person-sheet-btn.secondary { background:var(--bg); color:var(--muted); border:1px solid var(--border); }
.bubble-up-btn { width:100%; padding:0.65rem 1rem; border-radius:12px; background:linear-gradient(135deg,rgba(108,99,255,0.12),rgba(255,101,132,0.1)); border:1px solid rgba(108,99,255,0.3); color:var(--text); font-size:0.82rem; font-family:'Outfit',sans-serif; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:0.6rem; transition:all 0.2s; }
.bubble-up-btn:hover { border-color:rgba(108,99,255,0.6); }
.bubble-up-sub-text { font-size:0.65rem; color:var(--muted); font-weight:400; display:block; }
.bubble-up-confirm { display:none; flex-direction:column; gap:0.5rem; }
.bubble-up-confirm.show { display:flex; }
.bubble-up-confirm-text { font-size:0.78rem; color:var(--muted); line-height:1.5; }
.bubble-up-confirm-name { color:var(--accent); font-weight:600; }
.bubble-up-confirm-row { display:flex; gap:0.5rem; }
.bubble-up-yes { flex:2; padding:0.55rem; border-radius:10px; background:linear-gradient(135deg,var(--accent),#8b83ff); border:none; color:white; font-size:0.78rem; font-family:'Outfit',sans-serif; font-weight:600; cursor:pointer; }
.bubble-up-no { flex:1; padding:0.55rem; border-radius:10px; background:var(--bg); border:1px solid var(--border); color:var(--muted); font-size:0.78rem; font-family:'Outfit',sans-serif; cursor:pointer; }
.notif-card { background:var(--card); border-radius:16px; padding:0.9rem 1.1rem; margin-bottom:0.75rem; border:1px solid var(--border); }
.notif-card.invite { border-color:rgba(108,99,255,0.35); background:rgba(108,99,255,0.05); }
.notif-header { display:flex; align-items:center; gap:0.85rem; margin-bottom:0.5rem; }
.notif-avatar { width:40px; height:40px; border-radius:50%; font-size:0.78rem; font-weight:700; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.notif-title { font-size:0.88rem; font-weight:600; }
.notif-sub { font-size:0.73rem; color:var(--muted); }
.notif-actions { display:flex; gap:0.4rem; }
.notif-btn { padding:0.38rem 0.85rem; border-radius:8px; font-size:0.75rem; font-family:'Outfit',sans-serif; font-weight:600; cursor:pointer; border:none; }
.notif-btn.accept { background:linear-gradient(135deg,var(--accent),#8b83ff); color:white; }
.notif-btn.decline { background:var(--surface); color:var(--muted); border:1px solid var(--border); }

</style>
<script>
window.onerror = function(msg, src, line, col, err) {
  const el = document.getElementById('loading-msg');
  if (el) {
    el.textContent = '‚ùå JS Fejl linje ' + line + ': ' + msg;
    el.style.color = '#ff6584';
    el.style.fontSize = '0.75rem';
    el.style.maxWidth = '320px';
    el.style.margin = '1rem auto';
  }
  console.error('Global error:', msg, 'line:', line, err);
  return false;
};
window.onunhandledrejection = function(e) {
  const el = document.getElementById('loading-msg');
  if (el) {
    el.textContent = '‚ùå Promise fejl: ' + (e.reason?.message || e.reason || 'Ukendt');
    el.style.color = '#ff6584';
  }
  console.error('Unhandled rejection:', e.reason);
};
</script>
</head>
<body id="app-root" data-theme="midnight">

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: LOADING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen active" id="screen-loading">
  <div style="text-align:center">
    <div style="font-size:4rem;margin-bottom:0.5rem">ü´ß</div>
    <div style="font-size:1.8rem;font-weight:800;background:linear-gradient(135deg,#6c63ff,#ff6584);-webkit-background-clip:text;-webkit-text-fill-color:transparent">bubble</div>
    <div class="spinner" style="margin-top:2rem"></div>
    <div style="font-size:0.85rem;color:var(--muted);margin-top:1rem" id="loading-msg">Forbinder til server...</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: AUTH (Login / Signup)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-auth">
  <div style="text-align:center;margin-bottom:2.5rem">
    <div style="font-size:3.5rem;margin-bottom:0.75rem">ü´ß</div>
    <div style="font-size:2.4rem;font-weight:800;background:linear-gradient(135deg,#6c63ff,#ff6584);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:0.4rem">Bubble</div>
    <div style="font-size:0.9rem;color:var(--muted)">Network Radar for Business</div>
  </div>

  <div id="auth-login" style="width:100%;max-width:380px">
    <div class="input-group">
      <div class="input-label">Email</div>
      <input class="input" type="email" id="login-email" placeholder="din@email.dk" autocomplete="email">
    </div>
    <div class="input-group">
      <div class="input-label">Adgangskode</div>
      <input class="input" type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
    </div>
    <button class="btn-primary" onclick="handleLogin()">Log ind</button>
    <div style="display:flex;align-items:center;gap:0.75rem;margin:0.5rem 0">
      <div style="flex:1;height:1px;background:var(--border)"></div>
      <div style="font-size:0.75rem;color:var(--muted)">eller</div>
      <div style="flex:1;height:1px;background:var(--border)"></div>
    </div>
    <button class="btn-secondary" onclick="handleGoogleLogin()" style="display:flex;align-items:center;justify-content:center;gap:0.6rem">
      <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
      Forts√¶t med Google
    </button>
    <button class="btn-secondary" onclick="switchToSignup()">Opret ny konto</button>
  </div>

  <div id="auth-signup" style="width:100%;max-width:380px;display:none">
    <div class="input-group">
      <div class="input-label">Navn</div>
      <input class="input" type="text" id="signup-name" placeholder="Dit fulde navn" autocomplete="name">
    </div>
    <div class="input-group">
      <div class="input-label">Email</div>
      <input class="input" type="email" id="signup-email" placeholder="din@email.dk" autocomplete="email">
    </div>
    <div class="input-group">
      <div class="input-label">Adgangskode</div>
      <input class="input" type="password" id="signup-password" placeholder="Min. 6 tegn" autocomplete="new-password">
    </div>
    <div class="input-group">
      <div class="input-label">Titel / Rolle</div>
      <input class="input" type="text" id="signup-title" placeholder="f.eks. Founder ¬∑ Bubble">
    </div>
    <button class="btn-primary" onclick="handleSignup()">Opret konto</button>
    <button class="btn-secondary" onclick="switchToLogin()">Har allerede en konto</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: ONBOARDING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-onboarding">
  <div style="flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:2rem 1.5rem;display:flex;flex-direction:column;justify-content:center">
    <div style="text-align:center;margin-bottom:2rem">
      <div style="font-size:3rem;margin-bottom:0.5rem">ü´ß</div>
      <div style="font-size:1.6rem;font-weight:800;margin-bottom:0.4rem">N√¶sten klar!</div>
      <div style="font-size:0.9rem;color:var(--muted)">Udfyld din profil s√• andre kan finde dig</div>
    </div>
    <div class="input-group">
      <div class="input-label">Dit navn *</div>
      <input class="input" id="ob-name" placeholder="Dit fulde navn" autocomplete="name">
    </div>
    <div class="input-group">
      <div class="input-label">Titel / Rolle *</div>
      <input class="input" id="ob-title" placeholder="f.eks. Founder ¬∑ Bubble">
    </div>
    <div class="input-group">
      <div class="input-label">Om dig</div>
      <textarea class="input" id="ob-bio" placeholder="Kort om hvem du er og hvad du arbejder med..."></textarea>
    </div>
    <div class="input-group">
      <div class="input-label">N√∏gleord * (tryk Enter efter hvert)</div>
      <div class="chips-container" id="ob-chips-container" onclick="document.getElementById('ob-chip-input').focus()">
        <input class="chip-input" id="ob-chip-input" placeholder="f.eks. SaaS, AI, B√¶redygtighed..." onkeydown="handleChipInput(event,'ob-chips')">
      </div>
      <div style="font-size:0.72rem;color:var(--muted);margin-top:0.4rem">Mindst √©t n√∏gleord er p√•kr√¶vet</div>
    </div>
    <div class="input-group">
      <div class="input-label">LinkedIn URL (valgfrit)</div>
      <input class="input" id="ob-linkedin" placeholder="https://linkedin.com/in/dit-navn" type="url">
    </div>
    <button class="btn-primary" onclick="saveOnboarding()" style="margin-top:0.5rem">Kom i gang üöÄ</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: HOME
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-home">
  <div class="status-bar"><span id="home-time">9:41</span><span></span></div>
  <div class="topbar">
    <div class="topbar-logo" onclick="goTo('screen-home')" style="cursor:pointer">bubble</div>
    <div style="width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#6C63FF,#FF6584);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700;color:white;border:1.5px solid rgba(255,255,255,0.1)" id="home-avatar" onclick="goTo('screen-profile')">?</div>
  </div>

  <div class="scroll-area" id="home-scroll">

    <!-- Greeting -->
    <div style="padding:0.5rem 0 1.35rem">
      <div style="font-size:0.75rem;color:var(--muted);margin-bottom:0.3rem;letter-spacing:0.04em;text-transform:uppercase;font-weight:600">Goddag,</div>
      <div style="font-size:1.5rem;font-weight:800;letter-spacing:-0.02em" id="home-greeting-name">üëã</div>
    </div>

    <!-- 3 main cards -->
    <div style="display:flex;flex-direction:column;gap:0.85rem;margin-bottom:1.25rem">

      <!-- Bobler -->
      <div class="main-nav-card card-bobler" onclick="goTo('screen-bubbles')">
        <div class="main-nav-icon" style="background:rgba(108,99,255,0.2)">ü´ß</div>
        <div style="flex:1">
          <div style="font-weight:700;font-size:0.95rem;margin-bottom:0.18rem;letter-spacing:-0.01em">Bobler</div>
          <div style="font-size:0.78rem;color:var(--muted)" id="home-bubbles-sub">Henter...</div>
        </div>
        <div class="main-nav-badge badge-bobler" id="home-bubbles-badge" style="display:none"></div>
        <div style="color:var(--muted);font-size:1rem">‚Ä∫</div>
      </div>

      <!-- Beskeder -->
      <div class="main-nav-card card-beskeder" onclick="goTo('screen-messages')">
        <div class="main-nav-icon" style="background:rgba(255,101,132,0.2)">üí¨</div>
        <div style="flex:1">
          <div style="font-weight:700;font-size:0.95rem;margin-bottom:0.18rem;letter-spacing:-0.01em">Beskeder</div>
          <div style="font-size:0.78rem;color:var(--muted)" id="home-messages-sub">Henter...</div>
        </div>
        <div class="main-nav-badge badge-beskeder" id="home-messages-badge" style="display:none"></div>
        <div style="color:var(--muted);font-size:1rem">‚Ä∫</div>
      </div>

      <!-- Notifikationer -->
      <div class="main-nav-card card-notif" onclick="goTo('screen-notifications')">
        <div class="main-nav-icon" style="background:rgba(67,232,176,0.2)">üîî</div>
        <div style="flex:1">
          <div style="font-weight:700;font-size:0.95rem;margin-bottom:0.18rem;letter-spacing:-0.01em">Notifikationer</div>
          <div style="font-size:0.78rem;color:var(--muted)" id="home-notif-sub">Henter...</div>
        </div>
        <div class="main-nav-badge badge-notif" id="home-notif-badge" style="display:none"></div>
        <div style="color:var(--muted);font-size:1rem">‚Ä∫</div>
      </div>

    </div>

    <!-- Radar strip -->
    <div style="background:var(--surface);border-radius:var(--radius);padding:0.9rem 1.1rem;display:flex;align-items:center;gap:0.75rem;border:1px solid var(--border-subtle)">
      <div class="live-dot"></div>
      <div style="flex:1;font-size:0.78rem;color:var(--text-secondary)">
        <strong style="color:var(--text);font-weight:700">Din radar er aktiv</strong>
        <span id="radar-count-home"> ¬∑ Henter...</span>
      </div>
      <button class="btn-sm btn-ghost" onclick="goTo('screen-discover')" style="font-size:0.72rem;white-space:nowrap">Opdag ‚Üí</button>
    </div>

  </div>

  <div class="bottom-nav">
    <button class="nav-item active" onclick="goTo('screen-home')"><span class="nav-icon">üè†</span>Hjem</button>
    <button class="nav-item" onclick="goTo('screen-discover')"><span class="nav-icon">üîç</span>Opdag</button>
    <button class="nav-item" onclick="goTo('screen-messages')"><span class="nav-icon" style="position:relative">üí¨<div class="msg-unread-badge" style="display:none"></div></span>Beskeder</button>
    <button class="nav-item" onclick="goTo('screen-profile')"><span class="nav-icon">üë§</span>Profil</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: BUBBLES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-bubbles">
  <div class="status-bar"><span>9:41</span><span></span></div>
  <div class="topbar">
    <button class="back-btn" onclick="goTo('screen-home')">‚Üê Tilbage</button>
    <div class="topbar-logo">Bobler</div>
    <button class="btn-sm btn-ghost" onclick="openCreateBubble()" style="font-size:0.75rem;padding:0.35rem 0.75rem">+ Ny</button>
  </div>
  <div class="scroll-area">
    <div class="section-label" style="margin-top:0.25rem">üëë Mine bobler</div>
    <div id="my-owned-bubbles-list"><div class="spinner"></div></div>
    <div class="section-label">ü´ß Bobler jeg er med i</div>
    <div id="my-bubbles-list"><div class="spinner"></div></div>
  </div>
  <div class="bottom-nav">
    <button class="nav-item" onclick="goTo('screen-home')"><span class="nav-icon">üè†</span>Hjem</button>
    <button class="nav-item" onclick="goTo('screen-discover')"><span class="nav-icon">üîç</span>Opdag</button>
    <button class="nav-item" onclick="goTo('screen-messages')"><span class="nav-icon" style="position:relative">üí¨<div class="msg-unread-badge" style="display:none"></div></span>Beskeder</button>
    <button class="nav-item" onclick="goTo('screen-profile')"><span class="nav-icon">üë§</span>Profil</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: NOTIFICATIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-notifications">
  <div class="status-bar"><span>9:41</span><span></span></div>
  <div class="topbar">
    <button class="back-btn" onclick="goTo('screen-home')">‚Üê Tilbage</button>
    <div class="topbar-title" style="font-weight:800">Notifikationer</div>
  </div>
  <div class="scroll-area">
    <div id="notifications-list"><div class="spinner"></div></div>
  </div>
  <div class="bottom-nav">
    <button class="nav-item" onclick="goTo('screen-home')"><span class="nav-icon">üè†</span>Hjem</button>
    <button class="nav-item" onclick="goTo('screen-discover')"><span class="nav-icon">üîç</span>Opdag</button>
    <button class="nav-item" onclick="goTo('screen-messages')"><span class="nav-icon" style="position:relative">üí¨<div class="msg-unread-badge" style="display:none"></div></span>Beskeder</button>
    <button class="nav-item" onclick="goTo('screen-profile')"><span class="nav-icon">üë§</span>Profil</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: DISCOVER BUBBLES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-discover">
  <div class="status-bar"><span id="disc-time">9:41</span><span></span></div>
  <div class="topbar">
    <div class="topbar-title">Opdag bobler</div>
    <button class="btn-sm btn-accent" onclick="openCreateBubble()">+ Opret</button>
  </div>
  <div class="scroll-area">
    <input class="input" type="search" placeholder="S√∏g bobler..." id="bubble-search" oninput="filterBubbles()" style="margin-bottom:1rem">
    <div class="section-label">Alle bobler</div>
    <div id="all-bubbles-list"><div class="spinner"></div></div>
  </div>
  <div class="bottom-nav">
    <button class="nav-item" onclick="goTo('screen-home')"><span class="nav-icon">üè†</span>Hjem</button>
    <button class="nav-item active" onclick="goTo('screen-discover')"><span class="nav-icon">üîç</span>Opdag</button>
    <button class="nav-item" onclick="goTo('screen-messages')"><span class="nav-icon" style="position:relative">üí¨<div class="msg-unread-badge" style="display:none"></div></span>Beskeder</button>
    <button class="nav-item" onclick="goTo('screen-profile')"><span class="nav-icon">üë§</span>Profil</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: BUBBLE DETAIL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-bubble-detail">
  <div class="status-bar"><span>9:41</span><span></span></div>
  <div class="topbar">
    <button class="back-btn" id="bubble-back-btn">‚Üê Tilbage</button>
    <div style="display:flex;gap:0.5rem" id="bubble-join-area"></div>
  </div>
  <div class="scroll-area" style="padding:0">
    <div style="padding:1.35rem 1.4rem;background:linear-gradient(180deg,rgba(108,99,255,0.12) 0%,transparent 100%);border-bottom:1px solid var(--border-subtle)">
      <div style="font-size:2.2rem;margin-bottom:0.55rem" id="detail-icon">ü´ß</div>
      <div style="font-size:1.45rem;font-weight:800;margin-bottom:0.25rem;letter-spacing:-0.02em" id="detail-name">...</div>
      <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:0.85rem" id="detail-meta">...</div>
      <div id="detail-tags" style="margin-bottom:1.1rem"></div>
      <div style="display:flex;gap:0.5rem" id="detail-stats"></div>
    </div>
    <div style="padding:1.1rem 1.4rem">
      <div class="section-label" style="margin-top:0">Top matches til dig</div>
      <div id="bubble-members-list"><div class="spinner"></div></div>
    </div>
  </div>
  <div class="bottom-nav">
    <button class="nav-item" onclick="goTo('screen-home')"><span class="nav-icon">üè†</span>Hjem</button>
    <button class="nav-item" onclick="goTo('screen-discover')"><span class="nav-icon">üîç</span>Opdag</button>
    <button class="nav-item" onclick="goTo('screen-messages')"><span class="nav-icon" style="position:relative">üí¨<div class="msg-unread-badge" style="display:none"></div></span>Beskeder</button>
    <button class="nav-item" onclick="goTo('screen-profile')"><span class="nav-icon">üë§</span>Profil</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: PERSON PROFILE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-person" style="position:relative">
  <div class="scroll-area" style="padding:0">
    <!-- Cover -->
    <div class="person-cover" id="person-cover">
      <div class="person-cover-gradient" id="person-cover-grad"></div>
      <div class="person-cover-pattern"></div>
      <div style="position:absolute;bottom:0.75rem;left:0;right:0;display:flex;justify-content:space-between;padding:0 1rem;z-index:5">
        <button id="person-back-btn" onclick="" style="background:rgba(0,0,0,0.4);backdrop-filter:blur(8px);border:none;border-radius:99px;padding:0.3rem 0.8rem;color:white;font-size:0.8rem;font-family:inherit;cursor:pointer">‚Üê Tilbage</button>
        <div id="person-match-label" style="background:rgba(0,0,0,0.4);backdrop-filter:blur(8px);border-radius:99px;padding:0.3rem 0.8rem;font-size:0.75rem;font-weight:700;color:white"></div>
      </div>
    </div>
    <!-- Avatar + name -->
    <div class="person-info-section">
      <div class="person-avatar-wrap">
        <div class="person-avatar-ring" id="person-avatar">?</div>
      </div>
      <div style="margin-top:0.6rem">
        <div class="person-display-name" id="person-name">...</div>
        <div class="person-display-title" id="person-role">...</div>
        <div id="person-tags" style="margin-bottom:0.25rem"></div>
      </div>
    </div>
    <!-- Action bar -->
    <div class="person-action-bar">
      <button class="person-action-btn primary" onclick="proposeMeeting()">
        <span class="btn-icon">‚òï</span><span>M√∏de</span>
      </button>
      <button class="person-action-btn" onclick="startChat()">
        <span class="btn-icon">üí¨</span><span>Beskeder</span>
      </button>
      <button class="person-action-btn" onclick="saveContact()" id="save-btn">
        <span class="btn-icon">üîñ</span><span>Gem</span>
      </button>
      <a id="person-linkedin-btn" href="#" target="_blank" rel="noopener" class="person-action-btn linkedin" style="text-decoration:none;display:none">
        <span class="btn-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="#0A66C2"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></span><span>LinkedIn</span>
      </a>
    </div>
    <!-- Match -->
    <div class="person-section" id="person-overlap-section">
      <div class="person-section-title">üéØ F√¶lles interesser</div>
      <div id="person-overlap"></div>
    </div>
    <!-- Bio -->
    <div class="person-section" id="person-bio-section" style="display:none">
      <div class="person-section-title">Om</div>
      <div class="person-bio-text" id="person-bio"></div>
    </div>
    <!-- Dynamic keywords -->
    <div id="person-dynamic-keywords" style="padding:0 1.25rem 1rem"></div>
    <!-- Bubble-up -->
    <div style="padding:0 1.25rem 1.5rem">
      <button class="bubble-up-btn" id="person-bubbleup-btn" onclick="personTriggerBubbleUp()">
        <span style="font-size:1.1rem">ü´ß</span>
        <span>
          <span style="display:block;font-size:0.82rem;font-weight:600">Bubble up</span>
          <span class="bubble-up-sub-text">Opret en privat boble sammen</span>
        </span>
      </button>
      <div class="bubble-up-confirm" id="person-bubbleup-confirm" style="margin-top:0.65rem">
        <div class="bubble-up-confirm-text">Send en boble-invitation til <span class="bubble-up-confirm-name" id="person-bubbleup-name"></span>?<br>De skal acceptere ‚Äî begge bliver ejere.</div>
        <div class="bubble-up-confirm-row" style="margin-top:0.4rem">
          <button class="bubble-up-yes" onclick="personConfirmBubbleUp()">ü´ß Send invitation</button>
          <button class="bubble-up-no" onclick="personCancelBubbleUp()">Annuller</button>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: BOBLE CHAT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-bubble-chat">
  <div class="status-bar"><span id="bc-time">9:41</span><span></span></div>
  <div class="topbar">
    <button class="back-btn" id="bc-back-btn">‚Üê Tilbage</button>
    <div style="display:flex;align-items:center;gap:0.5rem;flex:1;margin-left:0.5rem">
      <span id="bc-emoji" style="font-size:1.3rem">ü´ß</span>
      <div>
        <div style="font-weight:700;font-size:0.95rem" id="bc-name">...</div>
        <div style="font-size:0.65rem;color:var(--muted)" id="bc-members-count">...</div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="bubble-tabs">
    <button class="bubble-tab active" id="bc-tab-chat" onclick="bcSwitchTab('chat')">Chat <span class="bubble-tab-badge" id="bc-unread-badge" style="display:none">0</span></button>
    <button class="bubble-tab" id="bc-tab-members" onclick="bcSwitchTab('members')">Medlemmer</button>
    <button class="bubble-tab" id="bc-tab-info" onclick="bcSwitchTab('info')">Info</button>
  </div>

  <!-- CHAT TAB -->
  <div id="bc-panel-chat" style="display:flex;flex-direction:column;flex:1;overflow:hidden">
    <div class="chat-messages" id="bc-messages"></div>
    <div class="chat-input-area">
      <div class="chat-edit-bar" id="bc-edit-bar">
        <span>‚úèÔ∏è Redigerer besked</span>
        <span class="chat-edit-cancel" onclick="bcCancelEdit()">‚úï</span>
      </div>
      <input type="file" id="bc-file-input" style="display:none" onchange="bcHandleFile(this)">
      <button class="chat-file-btn" onclick="document.getElementById('bc-file-input').click()">üìé</button>
      <input class="chat-input" id="bc-input" placeholder="Skriv til boblen..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();bcSendMessage()}">
      <button class="chat-send-btn" id="bc-send-btn" onclick="bcSendMessage()">‚Üí</button>
    </div>
  </div>

  <!-- MEMBERS TAB -->
  <div id="bc-panel-members" style="display:none;flex-direction:column;flex:1;overflow:hidden">
    <div class="chat-members-list" id="bc-members-list"></div>
  </div>

  <!-- INFO TAB -->
  <div id="bc-panel-info" style="display:none;flex-direction:column;flex:1;overflow:hidden">
    <div class="chat-info-list" id="bc-info-list"></div>
  </div>

  <!-- Context menu -->
  <div class="chat-context-menu" id="bc-context-menu">
    <div class="chat-context-item" id="bc-ctx-edit" style="display:none" onclick="bcStartEdit()">‚úèÔ∏è Rediger besked</div>
    <div class="chat-context-item" onclick="bcCloseContext()">‚Ü©Ô∏è Svar</div>
    <div class="chat-context-item" onclick="bcCloseContext()">üòÑ Reaktion</div>
    <div class="chat-context-divider"></div>
    <div class="chat-context-item danger" onclick="bcDeleteMessage()">üóë Slet</div>
  </div>

  <!-- Bottom nav -->
  <div class="bottom-nav">
    <button class="nav-item" onclick="goTo('screen-home')"><span class="nav-icon">üè†</span>Hjem</button>
    <button class="nav-item" onclick="goTo('screen-discover')"><span class="nav-icon">üîç</span>Opdag</button>
    <button class="nav-item" onclick="goTo('screen-messages')"><span class="nav-icon" style="position:relative">üí¨<div class="msg-unread-badge" style="display:none"></div></span>Beskeder</button>
    <button class="nav-item" onclick="goTo('screen-profile')"><span class="nav-icon">üë§</span>Profil</button>
  </div>
</div>

<!-- Person sheet (boble-chat avatar tap) -->
<div class="person-sheet-overlay" id="ps-overlay" onclick="psClose()"></div>
<div class="person-sheet" id="person-sheet-el">
  <div class="person-sheet-handle" onclick="psClose()"></div>
  <div class="person-sheet-header">
    <div class="person-sheet-avatar" id="ps-avatar"></div>
    <div>
      <div class="person-sheet-name" id="ps-name"></div>
      <div class="person-sheet-sub" id="ps-sub"></div>
    </div>
    <button class="person-sheet-close" onclick="psClose()">‚úï</button>
  </div>
  <div class="person-sheet-bio" id="ps-bio"></div>
  <div class="person-sheet-actions">
    <button class="person-sheet-btn primary" onclick="psMessage()">üí¨ Besked</button>
    <button class="person-sheet-btn secondary" onclick="psProfile()">üë§ Profil</button>
    <button class="person-sheet-btn secondary" onclick="psMeeting()">üìÖ M√∏de</button>
  </div>
  <!-- Bubble-up -->
  <button class="bubble-up-btn" id="ps-bubbleup-btn" onclick="psTriggerBubbleUp()">
    <span style="font-size:1.1rem">ü´ß</span>
    <span>
      <span style="display:block;font-size:0.82rem;font-weight:600">Bubble up</span>
      <span class="bubble-up-sub-text">Opret en privat boble sammen</span>
    </span>
  </button>
  <div class="bubble-up-confirm" id="ps-bubbleup-confirm">
    <div class="bubble-up-confirm-text">Send en boble-invitation til <span class="bubble-up-confirm-name" id="ps-bubbleup-name"></span>?<br>De skal acceptere ‚Äî begge bliver ejere.</div>
    <div class="bubble-up-confirm-row">
      <button class="bubble-up-yes" onclick="psConfirmBubbleUp()">ü´ß Send invitation</button>
      <button class="bubble-up-no" onclick="psCancelBubbleUp()">Annuller</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: MESSAGES LIST
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-messages">
  <div class="status-bar"><span>9:41</span><span></span></div>
  <div class="topbar">
    <div class="topbar-title">Beskeder</div>
    <button class="btn-sm btn-ghost" onclick="openCreateBubble()" style="font-size:0.72rem;padding:0.38rem 0.7rem">+ Ny boble</button>
  </div>
  <div class="scroll-area">
    <div id="conversations-list"><div class="spinner"></div></div>
  </div>
  <div class="bottom-nav">
    <button class="nav-item" onclick="goTo('screen-home')"><span class="nav-icon">üè†</span>Hjem</button>
    <button class="nav-item" onclick="goTo('screen-discover')"><span class="nav-icon">üîç</span>Opdag</button>
    <button class="nav-item active" onclick="goTo('screen-messages')"><span class="nav-icon" style="position:relative">üí¨<div class="msg-unread-badge" style="display:none"></div></span>Beskeder</button>
    <button class="nav-item" onclick="goTo('screen-profile')"><span class="nav-icon">üë§</span>Profil</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: CHAT THREAD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-chat">
  <div class="status-bar"><span>9:41</span><span></span></div>
  <div class="topbar">
    <button class="back-btn" onclick="goTo('screen-messages')">‚Üê Tilbage</button>
    <div style="text-align:right">
      <div style="font-size:0.88rem;font-weight:700;letter-spacing:-0.01em" id="chat-name">...</div>
      <div style="font-size:0.68rem;color:var(--text-secondary)" id="chat-role">...</div>
    </div>
  </div>
  <div class="scroll-area" id="chat-messages" style="padding:1rem 1.25rem;display:flex;flex-direction:column"></div>
  <div class="thread-input-row">
    <input class="thread-input" id="chat-input" placeholder="Skriv en besked..." onkeydown="if(event.key==='Enter')sendMessage()">
    <button class="send-btn" onclick="sendMessage()">‚Üí</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN: MY PROFILE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-profile">
  <div class="status-bar"><span>9:41</span><span></span></div>
  <div class="topbar">
    <div class="topbar-title">Min profil</div>
    <button class="btn-sm btn-ghost" onclick="openEditProfile()">Rediger</button>
  </div>
  <div class="scroll-area" style="padding:0">
    <div class="profile-hero">
      <div style="width:76px;height:76px;border-radius:50%;background:linear-gradient(135deg,#6C63FF,#FF6584);margin:0 auto 0.9rem;display:flex;align-items:center;justify-content:center;font-size:1.7rem;font-weight:800;color:white;box-shadow:0 4px 20px rgba(108,99,255,0.35);border:2px solid rgba(255,255,255,0.08)" id="my-avatar">?</div>
      <div style="font-size:1.3rem;font-weight:800;margin-bottom:0.2rem;letter-spacing:-0.02em" id="my-name">...</div>
      <div style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:0.85rem" id="my-role">...</div>
      <div id="my-keywords" style="margin-bottom:0.5rem"></div>
    </div>
    <div style="padding:1rem 1.25rem">
      <div class="section-label">Synlighed</div>
      <div class="card" style="display:flex;justify-content:space-between;align-items:center;cursor:default">
        <div>
          <div style="font-size:0.88rem;font-weight:700">Anonym tilstand</div>
          <div style="font-size:0.73rem;color:var(--text-secondary);margin-top:0.15rem">Skjul navn og billede</div>
        </div>
        <div id="anon-toggle" onclick="toggleAnon()" style="width:46px;height:26px;background:var(--border);border-radius:99px;cursor:pointer;position:relative;transition:background 0.2s">
          <div id="anon-knob" style="width:20px;height:20px;background:var(--muted);border-radius:50%;position:absolute;top:3px;left:3px;transition:all 0.2s"></div>
        </div>
      </div>
      <!-- Theme Picker -->
      <div class="section-label" style="margin-top:1.25rem">üé® Tema</div>
      <div style="position:relative;margin-bottom:1rem">
        <div id="theme-dropdown-btn" onclick="toggleThemeDropdown()" style="
          display:flex;align-items:center;justify-content:space-between;
          background:var(--card);border:1px solid var(--border);
          border-radius:var(--radius,12px);padding:0.75rem 1rem;
          cursor:pointer;gap:0.75rem">
          <div style="display:flex;align-items:center;gap:0.65rem">
            <div id="theme-swatch-preview" style="width:28px;height:28px;border-radius:7px;flex-shrink:0;background:linear-gradient(135deg,#0A0E1A,#60A5FA)"></div>
            <span id="theme-label-current" style="font-weight:600;font-size:0.9rem;color:var(--text)">üåô Midnight</span>
          </div>
          <span id="theme-chevron" style="color:var(--muted);font-size:0.8rem;transition:transform 0.2s">‚ñº</span>
        </div>
        <div id="theme-dropdown" style="
          display:none;position:absolute;left:0;right:0;top:calc(100% + 6px);
          background:var(--card);border:1px solid var(--border);
          border-radius:var(--radius,12px);z-index:100;overflow:hidden;
          box-shadow:0 8px 24px rgba(0,0,0,0.15)">
          <div style="max-height:260px;overflow-y:auto">
            <div class="theme-option" data-theme="midnight" data-preview="linear-gradient(135deg,#0A0E1A,#60A5FA)" data-label="üåô Midnight" onclick="selectTheme(this)"><div class="theme-opt-swatch" style="background:linear-gradient(135deg,#0A0E1A,#60A5FA)"></div>üåô Midnight</div>
            <div class="theme-option" data-theme="arctic" data-preview="linear-gradient(135deg,#F8F9FB,#2563EB)" data-label="‚ùÑÔ∏è Arctic" onclick="selectTheme(this)"><div class="theme-opt-swatch" style="background:linear-gradient(135deg,#F8F9FB,#2563EB)"></div>‚ùÑÔ∏è Arctic</div>
            <div class="theme-option" data-theme="noir" data-preview="linear-gradient(135deg,#0C0C0C,#FFFFFF)" data-label="‚¨õ Noir" onclick="selectTheme(this)"><div class="theme-opt-swatch" style="background:linear-gradient(135deg,#0C0C0C,#FFFFFF)"></div>‚¨õ Noir</div>
            <div class="theme-option" data-theme="forest" data-preview="linear-gradient(135deg,#F2F5F0,#2D6A4F)" data-label="üåø Forest" onclick="selectTheme(this)"><div class="theme-opt-swatch" style="background:linear-gradient(135deg,#F2F5F0,#2D6A4F)"></div>üåø Forest</div>
            <div class="theme-option" data-theme="coral" data-preview="linear-gradient(135deg,#FFF8F6,#E8450A)" data-label="ü™∏ Coral" onclick="selectTheme(this)"><div class="theme-opt-swatch" style="background:linear-gradient(135deg,#FFF8F6,#E8450A)"></div>ü™∏ Coral</div>
            <div class="theme-option" data-theme="violet" data-preview="linear-gradient(135deg,#F5F3FF,#7C3AED)" data-label="üíú Violet" onclick="selectTheme(this)"><div class="theme-opt-swatch" style="background:linear-gradient(135deg,#F5F3FF,#7C3AED)"></div>üíú Violet</div>
            <div class="theme-option" data-theme="ocean" data-preview="linear-gradient(135deg,#EBF4FC,#0066CC)" data-label="üåä Ocean" onclick="selectTheme(this)"><div class="theme-opt-swatch" style="background:linear-gradient(135deg,#EBF4FC,#0066CC)"></div>üåä Ocean</div>
            <div class="theme-option" data-theme="sunset" data-preview="linear-gradient(135deg,#FFF7F0,#EA580C)" data-label="üåÖ Sunset" onclick="selectTheme(this)"><div class="theme-opt-swatch" style="background:linear-gradient(135deg,#FFF7F0,#EA580C)"></div>üåÖ Sunset</div>
            <div class="theme-option" data-theme="nordic" data-preview="linear-gradient(135deg,#F5F0EB,#4A3D30)" data-label="üèî Nordic" onclick="selectTheme(this)"><div class="theme-opt-swatch" style="background:linear-gradient(135deg,#F5F0EB,#4A3D30)"></div>üèî Nordic</div>
            <div class="theme-option" data-theme="neon" data-preview="linear-gradient(135deg,#06040F,#A855F7)" data-label="‚ö° Neon" onclick="selectTheme(this)"><div class="theme-opt-swatch" style="background:linear-gradient(135deg,#06040F,#A855F7)"></div>‚ö° Neon</div>
            <div class="theme-option" data-theme="slate" data-preview="linear-gradient(135deg,#F1F3F6,#374151)" data-label="ü™® Slate" onclick="selectTheme(this)"><div class="theme-opt-swatch" style="background:linear-gradient(135deg,#F1F3F6,#374151)"></div>ü™® Slate</div>
            <div class="theme-option" data-theme="sand" data-preview="linear-gradient(135deg,#FAF7F2,#B8860B)" data-label="üèú Sand" onclick="selectTheme(this)"><div class="theme-opt-swatch" style="background:linear-gradient(135deg,#FAF7F2,#B8860B)"></div>üèú Sand</div>
            <div class="theme-option" data-theme="rose" data-preview="linear-gradient(135deg,#FFF5F7,#BE185D)" data-label="üå∏ Rose" onclick="selectTheme(this)"><div class="theme-opt-swatch" style="background:linear-gradient(135deg,#FFF5F7,#BE185D)"></div>üå∏ Rose</div>
            <div class="theme-option" data-theme="deepsea" data-preview="linear-gradient(135deg,#050E1A,#38BDF8)" data-label="üêã Deep Sea" onclick="selectTheme(this)"><div class="theme-opt-swatch" style="background:linear-gradient(135deg,#050E1A,#38BDF8)"></div>üêã Deep Sea</div>
            <div class="theme-option" data-theme="editorial" data-preview="linear-gradient(135deg,#FFFEF9,#1A1A14)" data-label="üì∞ Editorial" onclick="selectTheme(this)"><div class="theme-opt-swatch" style="background:linear-gradient(135deg,#FFFEF9,#1A1A14)"></div>üì∞ Editorial</div>
          </div>
        </div>
      </div>

      <div class="section-label" style="margin-top:1.25rem">Mine bobler</div>
      <div id="profile-bubbles"><div class="spinner"></div></div>
      <div class="section-label">Gemte kontakter</div>
      <div id="saved-contacts" style="display:flex;flex-wrap:wrap;gap:0.75rem;padding-bottom:1rem"></div>
      <button class="btn-secondary" onclick="handleLogout()" style="margin-top:1rem;color:var(--accent2);border-color:rgba(255,101,132,0.3)">Log ud</button>
    </div>
  </div>
  <div class="bottom-nav">
    <button class="nav-item" onclick="goTo('screen-home')"><span class="nav-icon">üè†</span>Hjem</button>
    <button class="nav-item" onclick="goTo('screen-discover')"><span class="nav-icon">üîç</span>Opdag</button>
    <button class="nav-item" onclick="goTo('screen-messages')"><span class="nav-icon" style="position:relative">üí¨<div class="msg-unread-badge" style="display:none"></div></span>Beskeder</button>
    <button class="nav-item active"><span class="nav-icon">üë§</span>Profil</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL: EDIT BUBBLE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-edit-bubble">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Rediger boble ‚úèÔ∏è</div>
    <div class="input-group">
      <div class="input-label">Navn</div>
      <input class="input" id="eb-name" placeholder="Boble navn">
    </div>
    <div class="input-group">
      <div class="input-label">Type</div>
      <select class="input" id="eb-type">
        <option value="event">üöÄ Event</option>
        <option value="local">üìç Lokal</option>
        <option value="theme">ü§ñ Tematiseret</option>
        <option value="company">üè¢ Virksomhed</option>
      </select>
    </div>
    <div class="input-group">
      <div class="input-label">Synlighed</div>
      <select class="input" id="eb-visibility">
        <option value="public">üåç Offentlig ‚Äî synlig, alle kan joine</option>
        <option value="private">üîí Privat ‚Äî synlig, join kr√¶ver anmodning</option>
        <option value="hidden">üëÅÔ∏è Skjult ‚Äî usynlig, kun via QR-invitation</option>
      </select>
    </div>
    <div class="input-group">
      <div class="input-label">Beskrivelse</div>
      <textarea class="input" id="eb-desc" placeholder="Hvad handler denne boble om?"></textarea>
    </div>
    <div class="input-group">
      <div class="input-label">N√∏gleord</div>
      <div class="chips-container" id="eb-chips-container" onclick="document.getElementById('eb-chip-input').focus()">
        <input class="chip-input" id="eb-chip-input" placeholder="Tilf√∏j n√∏gleord..." onkeydown="handleChipInput(event,'eb-chips')">
      </div>
    </div>
    <div class="input-group">
      <div class="input-label">Lokation (valgfrit)</div>
      <input class="input" id="eb-location" placeholder="f.eks. K√∏benhavn">
    </div>
    <button class="btn-primary" onclick="saveEditBubble()">Gem √¶ndringer</button>
    <button class="btn-secondary" onclick="closeModal('modal-edit-bubble')">Annuller</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL: CREATE BUBBLE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-create-bubble">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Opret ny boble ü´ß</div>
    <div class="input-group">
      <div class="input-label">Navn</div>
      <input class="input" id="cb-name" placeholder="f.eks. TechBBQ 2025">
    </div>
    <div class="input-group">
      <div class="input-label">Type</div>
      <select class="input" id="cb-type">
        <option value="event">üöÄ Event</option>
        <option value="local">üìç Lokal</option>
        <option value="theme">ü§ñ Tematiseret</option>
        <option value="company">üè¢ Virksomhed</option>
      </select>
    </div>
    <div class="input-group">
      <div class="input-label">Synlighed</div>
      <select class="input" id="cb-visibility">
        <option value="public">üåç Offentlig ‚Äî synlig, alle kan joine</option>
        <option value="private">üîí Privat ‚Äî synlig, join kr√¶ver anmodning</option>
        <option value="hidden">üëÅÔ∏è Skjult ‚Äî usynlig, kun via QR-invitation</option>
      </select>
    </div>
    <div class="input-group">
      <div class="input-label">Beskrivelse</div>
      <textarea class="input" id="cb-desc" placeholder="Hvad handler denne boble om?"></textarea>
    </div>
    <div class="input-group">
      <div class="input-label">N√∏gleord (tryk Enter for at tilf√∏je)</div>
      <div class="chips-container" id="cb-chips-container" onclick="document.getElementById('cb-chip-input').focus()">
        <input class="chip-input" id="cb-chip-input" placeholder="Tilf√∏j n√∏gleord..." onkeydown="handleChipInput(event,'cb-chips')">
      </div>
    </div>
    <div class="input-group">
      <div class="input-label">Lokation (valgfrit)</div>
      <input class="input" id="cb-location" placeholder="f.eks. K√∏benhavn">
    </div>
    <button class="btn-primary" onclick="createBubble()">Opret boble</button>
    <button class="btn-secondary" onclick="closeModal('modal-create-bubble')">Annuller</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL: EDIT PROFILE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-edit-profile">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Rediger profil</div>
    <div class="input-group">
      <div class="input-label">Navn</div>
      <input class="input" id="ep-name">
    </div>
    <div class="input-group">
      <div class="input-label">Titel / Rolle</div>
      <input class="input" id="ep-title" placeholder="f.eks. Founder ¬∑ Bubble">
    </div>
    <div class="input-group">
      <div class="input-label">Om dig</div>
      <textarea class="input" id="ep-bio" placeholder="Skriv kort om dig selv og hvad du s√∏ger..."></textarea>
    </div>
    <div class="input-group">
      <div class="input-label">N√∏gleord (tryk Enter)</div>
      <div class="chips-container" id="ep-chips-container" onclick="document.getElementById('ep-chip-input').focus()">
        <input class="chip-input" id="ep-chip-input" placeholder="f.eks. SaaS, AI, Networking..." onkeydown="handleChipInput(event,'ep-chips')">
      </div>
    </div>
    <div class="input-group">
      <div class="input-label">Dynamiske n√∏gleord (hvad du s√∏ger nu)</div>
      <div class="chips-container" id="ep-dyn-chips-container" onclick="document.getElementById('ep-dyn-chip-input').focus()">
        <input class="chip-input" id="ep-dyn-chip-input" placeholder="f.eks. S√∏ger investor, Open to coffee..." onkeydown="handleChipInput(event,'ep-dyn-chips')">
      </div>
    </div>
    <div class="input-group">
      <div class="input-label">LinkedIn URL (valgfrit)</div>
      <input class="input" id="ep-linkedin" placeholder="https://linkedin.com/in/dit-navn" type="url">
    </div>
    <button class="btn-primary" onclick="saveProfile()">Gem profil</button>
    <button class="btn-secondary" onclick="closeModal('modal-edit-profile')">Annuller</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL: QR CODE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-qr">
  <div class="modal-sheet" style="text-align:center">
    <div class="modal-handle"></div>
    <div class="modal-title" id="qr-modal-title">QR-kode ü´ß</div>
    <div style="font-size:0.85rem;color:var(--muted);margin-bottom:1.25rem" id="qr-modal-subtitle">Vis eller print denne kode ved indgangen</div>

    <!-- QR code renders here -->
    <div style="display:flex;justify-content:center;margin-bottom:1.25rem">
      <div id="qr-canvas-wrap" style="background:white;padding:16px;border-radius:16px;display:inline-block">
        <div id="qr-code-el"></div>
      </div>
    </div>

    <div style="font-size:0.78rem;color:var(--muted);margin-bottom:1.5rem">
      Scan med iPhone-kamera for at joine boblen direkte
    </div>

    <button class="btn-primary" onclick="downloadQRPdf()">‚¨áÔ∏è Download PDF til print</button>
    <button class="btn-secondary" onclick="closeModal('modal-qr')">Luk</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL: PROPOSE MEETING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-meeting">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Foresl√• et m√∏de ‚òï</div>
    <div class="input-group">
      <div class="input-label">Besked</div>
      <textarea class="input" id="meeting-msg" placeholder="Hej! Jeg s√• du er med i [boble]. Vil du tage en kop kaffe og h√∏re mere om...?" style="min-height:120px"></textarea>
    </div>
    <div class="input-group">
      <div class="input-label">Foresl√• tidspunkt (valgfrit)</div>
      <input class="input" type="datetime-local" id="meeting-time">
    </div>
    <button class="btn-primary" onclick="sendMeetingProposal()">Send m√∏deanmodning</button>
    <button class="btn-secondary" onclick="closeModal('modal-meeting')">Annuller</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUPABASE INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let sb;
let currentUser = null;
let currentProfile = null;
let currentBubble = null;
let currentPerson = null;
let currentChatUser = null;
let allBubbles = [];
let cbChips = [], epChips = [], epDynChips = [], ebChips = [], obChips = [];
let chatSubscription = null;
let isAnon = false;

function initSupabase() {
  if (SUPABASE_URL === "DIN_SUPABASE_URL_HER") {
    document.getElementById('loading-msg').textContent = '‚ö†Ô∏è Inds√¶t dine Supabase-n√∏gler i filen';
    document.getElementById('loading-msg').style.color = '#ff6584';
    return false;
  }
  try {
    sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    return true;
  } catch(e) {
    document.getElementById('loading-msg').textContent = 'Fejl: ' + e.message;
    return false;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goTo(screenId) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(screenId).classList.add('active');
  window.scrollTo(0,0);

  // Load data for screen
  if (screenId === 'screen-home') loadHome();
  if (screenId === 'screen-bubbles') loadMyBubbles();
  if (screenId === 'screen-notifications') loadNotifications();
  if (screenId === 'screen-discover') loadDiscover();
  if (screenId === 'screen-messages') loadMessages();
  if (screenId === 'screen-profile') loadProfile();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function checkAuth() {
  if (!initSupabase()) return;
  try {
    // Handle OAuth redirect ‚Äî Supabase v2 processes hash automatically
    if (window.location.hash && window.location.hash.includes('access_token')) {
      document.getElementById('loading-msg').textContent = 'Logger ind via Google...';
      // Give Supabase a moment to process the hash
      await new Promise(r => setTimeout(r, 500));
      // Clean URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }

    const { data: { session } } = await sb.auth.getSession();
    if (session) {
      currentUser = session.user;
      // Ensure profile row exists (Google users may not have one)
      const { data: existingProfile } = await sb.from('profiles').select('id').eq('id', session.user.id).single();
      if (!existingProfile) {
        const meta = session.user.user_metadata || {};
        await sb.from('profiles').upsert({
          id: session.user.id,
          name: meta.full_name || meta.name || session.user.email,
          title: '', keywords: [], dynamic_keywords: [], bio: '', is_anon: false
        });
      }
      await loadCurrentProfile();
      const needsOnboarding = await maybeShowOnboarding();
      if (!needsOnboarding) goTo('screen-home');
    } else {
      goTo('screen-auth');
    }
  } catch(e) {
    document.getElementById('loading-msg').textContent = 'Fejl: ' + e.message;
    document.getElementById('loading-msg').style.color = '#ff6584';
  }
}

async function loadCurrentProfile() {
  const { data } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
  if (data) {
    currentProfile = data;
    updateHomeAvatar();
  }
}

function updateHomeAvatar() {
  if (!currentProfile) return;
  const initials = (currentProfile.name || '?').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
  document.getElementById('home-avatar').textContent = initials;
  document.getElementById('my-avatar').textContent = initials;
}

async function handleLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pass = document.getElementById('login-password').value;
  if (!email || !pass) return showToast('Udfyld email og adgangskode');
  showToast('Logger ind...');
  const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
  if (error) return showToast('Fejl: ' + error.message);
  currentUser = data.user;
  await loadCurrentProfile();
  const needsOnboarding = await maybeShowOnboarding();
  if (!needsOnboarding) goTo('screen-home');
}

async function handleSignup() {
  const name  = document.getElementById('signup-name').value.trim();
  const email = document.getElementById('signup-email').value.trim();
  const pass  = document.getElementById('signup-password').value;
  const title = document.getElementById('signup-title').value.trim();
  if (!name || !email || !pass) return showToast('Udfyld alle felter');
  if (pass.length < 6) return showToast('Adgangskode skal v√¶re min. 6 tegn');
  showToast('Opretter konto...');
  const { data, error } = await sb.auth.signUp({ email, password: pass });
  if (error) return showToast('Fejl: ' + error.message);
  currentUser = data.user;

  // Retry profile creation a few times ‚Äî auth sometimes needs a moment to propagate
  let profileCreated = false;
  for (let i = 0; i < 5; i++) {
    await new Promise(r => setTimeout(r, 500));
    const { error: profileError } = await sb.from('profiles').upsert({
      id: currentUser.id,
      name, title, keywords: [], dynamic_keywords: [], bio: '', is_anon: false
    });
    if (!profileError) { profileCreated = true; break; }
  }

  if (!profileCreated) {
    showToast('Konto oprettet ‚Äî udfyld profil under Rediger üë§');
  }

  await loadCurrentProfile();
  goTo('screen-home');
  showToast('Velkommen til Bubble! ü´ß');
}

async function handleLogout() {
  await sb.auth.signOut();
  currentUser = null; currentProfile = null;
  goTo('screen-auth');
}

function switchToSignup() {
  document.getElementById('auth-login').style.display = 'none';
  document.getElementById('auth-signup').style.display = 'block';
}
function switchToLogin() {
  document.getElementById('auth-signup').style.display = 'none';
  document.getElementById('auth-login').style.display = 'block';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HOME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadHome() {
  if (!currentProfile) await loadCurrentProfile();
  updateHomeAvatar();

  // Greeting
  const nameEl = document.getElementById('home-greeting-name');
  if (nameEl && currentProfile?.name) {
    nameEl.textContent = (currentProfile.name.split(' ')[0]) + ' üëã';
  }

  // Load all dashboard data in parallel
  await Promise.all([
    loadHomeBubblesCard(),
    loadHomeMessagesCard(),
    loadHomeNotifCard(),
    updateRadarCount(),
  ]);

  // Also load bubbles screen data if it exists
  loadMyBubbles();
}

async function loadHomeBubblesCard() {
  const sub = document.getElementById('home-bubbles-sub');
  const badge = document.getElementById('home-bubbles-badge');
  const { data: memberships } = await sb.from('bubble_members').select('bubble_id').eq('user_id', currentUser.id);
  const count = memberships?.length || 0;
  if (sub) sub.textContent = count > 0 ? `${count} aktiv${count !== 1 ? 'e' : ''} boble${count !== 1 ? 'r' : ''}` : 'Du er ikke i nogen bobler endnu';
  if (badge) { badge.textContent = count; badge.style.display = count > 0 ? 'flex' : 'none'; }
}

async function loadHomeMessagesCard() {
  const sub = document.getElementById('home-messages-sub');
  const badge = document.getElementById('home-messages-badge');
  const { data: msgs } = await sb.from('messages')
    .select('*').or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
    .order('created_at', {ascending:false}).limit(1);
  const { count: unread } = await sb.from('messages')
    .select('*', {count:'exact',head:true}).eq('receiver_id', currentUser.id).is('read_at', null);
  if (sub) sub.textContent = unread > 0 ? `${unread} ul√¶ste beskeder` : msgs?.length > 0 ? `Sidst: "${msgs[0].content?.slice(0,30)}..."` : 'Ingen beskeder endnu';
  if (badge) { badge.textContent = unread; badge.style.display = unread > 0 ? 'flex' : 'none'; }
}

async function loadHomeNotifCard() {
  const sub = document.getElementById('home-notif-sub');
  const badge = document.getElementById('home-notif-badge');
  // Count new bubble members since last 7 days
  const since = new Date(Date.now() - 7*24*60*60*1000).toISOString();
  const { data: memberships } = await sb.from('bubble_members').select('bubble_id').eq('user_id', currentUser.id);
  if (!memberships || memberships.length === 0) {
    if (sub) sub.textContent = 'Ingen notifikationer';
    return;
  }
  const ids = memberships.map(m => m.bubble_id);
  const { count } = await sb.from('bubble_members')
    .select('*', {count:'exact',head:true})
    .in('bubble_id', ids).neq('user_id', currentUser.id).gte('joined_at', since);
  const n = count || 0;
  if (sub) sub.textContent = n > 0 ? `${n} nye i dine bobler` : 'Ingen nye notifikationer';
  if (badge) { badge.textContent = n; badge.style.display = n > 0 ? 'flex' : 'none'; }
}

async function loadMyBubbles() {
  const ownedList  = document.getElementById('my-owned-bubbles-list');
  const joinedList = document.getElementById('my-bubbles-list');
  ownedList.innerHTML  = '<div class="spinner"></div>';
  joinedList.innerHTML = '<div class="spinner"></div>';

  const { data: memberships } = await sb.from('bubble_members')
    .select('bubble_id').eq('user_id', currentUser.id);

  if (!memberships || memberships.length === 0) {
    ownedList.innerHTML  = '<div style="font-size:0.82rem;color:var(--muted);padding:0.5rem 0">Du har ikke oprettet nogen bobler endnu.</div>';
    joinedList.innerHTML = '<div class="empty-state"><div class="empty-icon">ü´ß</div><div class="empty-text">Du er ikke i nogen bobler endnu.<br>Opdag eller opret en boble!</div></div>';
    return;
  }

  const ids = memberships.map(m => m.bubble_id);
  const { data: bubbles } = await sb.from('bubbles').select('*').in('id', ids);
  if (!bubbles || bubbles.length === 0) {
    ownedList.innerHTML = joinedList.innerHTML = '';
    return;
  }

  const owned  = bubbles.filter(b => b.created_by === currentUser.id);
  const joined = bubbles.filter(b => b.created_by !== currentUser.id);

  // Owned bubbles ‚Äî show with visibility badge + edit shortcut
  if (owned.length === 0) {
    ownedList.innerHTML = '<div style="font-size:0.82rem;color:var(--muted);padding:0.5rem 0">Du har ikke oprettet nogen bobler endnu.</div>';
  } else {
    ownedList.innerHTML = owned.map(b => {
      const visIcon = b.visibility === 'private' ? 'üîí' : b.visibility === 'hidden' ? 'üëÅÔ∏è' : 'üåç';
      return `<div class="card" style="display:flex;align-items:center;gap:0.85rem" onclick="openBubble('${b.id}')">
        <div class="bubble-icon" style="background:${bubbleColor(b.type, 0.15)}">${bubbleEmoji(b.type)}</div>
        <div style="flex:1">
          <div style="font-weight:600;font-size:0.9rem">${escHtml(b.name)}</div>
          <div style="font-size:0.75rem;color:var(--muted)">${visIcon} ${b.type_label||b.type}${b.location ? ' ¬∑ '+escHtml(b.location) : ''}</div>
        </div>
        <div style="display:flex;gap:0.4rem;align-items:center">
          <button class="btn-sm btn-ghost" onclick="event.stopPropagation();openEditBubble('${b.id}')" style="font-size:0.8rem;padding:0.3rem 0.5rem">‚úèÔ∏è</button>
          <div class="live-dot"></div>
        </div>
      </div>`;
    }).join('');
  }

  // Joined bubbles
  if (joined.length === 0) {
    joinedList.innerHTML = '<div style="font-size:0.82rem;color:var(--muted);padding:0.5rem 0">Du er ikke medlem af andres bobler endnu.</div>';
  } else {
    joinedList.innerHTML = joined.map(b => bubbleCard(b, true)).join('');
  }

  // Profile bubbles
  document.getElementById('profile-bubbles').innerHTML = bubbles.map(b =>
    `<div class="card" style="padding:0.85rem 1.1rem;cursor:default">
      <div style="font-weight:600;font-size:0.9rem">${bubbleEmoji(b.type)} ${escHtml(b.name)}</div>
      <div style="font-size:0.75rem;color:var(--muted);margin-top:0.2rem">${b.created_by === currentUser.id ? 'üëë Ejer' : 'Aktiv'}</div>
    </div>`).join('');
}

async function updateRadarCount() {
  const { data: memberships } = await sb.from('bubble_members').select('bubble_id').eq('user_id', currentUser.id);
  const rcEl = document.getElementById('radar-count-home');
  if (!memberships || memberships.length === 0) {
    if (rcEl) rcEl.textContent = ' ¬∑ Join en boble for at se matches';
    return;
  }
  const ids = memberships.map(m => m.bubble_id);
  const { count } = await sb.from('bubble_members').select('*', {count:'exact',head:true}).in('bubble_id', ids).neq('user_id', currentUser.id);
  if (rcEl) rcEl.textContent = ` ¬∑ ${count || 0} profiler synlige i dine bobler`;
}

function bubbleCard(b, joined) {
  return `<div class="card" style="display:flex;align-items:center;gap:0.85rem" onclick="openBubble('${b.id}')">
    <div class="bubble-icon" style="background:${bubbleColor(b.type, 0.15)}">${bubbleEmoji(b.type)}</div>
    <div style="flex:1">
      <div style="font-weight:600;font-size:0.9rem">${escHtml(b.name)}</div>
      <div style="font-size:0.75rem;color:var(--muted)">${escHtml(b.type_label || b.type)} ${b.location ? '¬∑ ' + escHtml(b.location) : ''}</div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:0.3rem">
      <div style="font-weight:700">${b.member_count || ''}</div>
      ${joined ? '<div class="live-dot"></div>' : '<div style="font-size:0.9rem;color:var(--accent)">+</div>'}
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DISCOVER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadDiscover() {
  const list = document.getElementById('all-bubbles-list');
  list.innerHTML = '<div class="spinner"></div>';
  const { data: bubbles } = await sb.from('bubbles').select('*, bubble_members(count)').or('visibility.eq.public,visibility.eq.private,visibility.is.null').order('created_at', {ascending:false});
  allBubbles = (bubbles || []).map(b => ({
    ...b,
    member_count: b.bubble_members?.[0]?.count || 0,
    type_label: typeLabel(b.type)
  }));
  renderBubbleList(allBubbles);
}

function renderBubbleList(bubbles) {
  const list = document.getElementById('all-bubbles-list');
  if (!bubbles.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-icon">üîç</div><div class="empty-text">Ingen bobler endnu.<br>Opret den f√∏rste!</div></div>';
    return;
  }
  list.innerHTML = bubbles.map(b => bubbleCard(b, false)).join('');
}

function filterBubbles() {
  const q = document.getElementById('bubble-search').value.toLowerCase();
  const filtered = q ? allBubbles.filter(b =>
    b.name.toLowerCase().includes(q) || (b.keywords || []).some(k => k.toLowerCase().includes(q))
  ) : allBubbles;
  renderBubbleList(filtered);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BUBBLE DETAIL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openBubble(bubbleId, fromScreen) {
  currentBubble = bubbleId;
  const backBtn = document.getElementById('bubble-back-btn');
  backBtn.onclick = () => goTo(fromScreen || 'screen-home');

  goTo('screen-bubble-detail');

  const { data: b } = await sb.from('bubbles').select('*').eq('id', bubbleId).single();
  if (!b) return;

  document.getElementById('detail-icon').textContent = bubbleEmoji(b.type);
  document.getElementById('detail-name').textContent = b.name;
  // Member count
  const memberCountEl = document.getElementById('bubble-member-count');
  if (memberCountEl) {
    const { count } = await sb.from('bubble_members').select('*', {count:'exact',head:true}).eq('bubble_id', b.id);
    memberCountEl.textContent = (count || 0) + ' deltagere';
  }
  document.getElementById('detail-meta').textContent = `${typeLabel(b.type)}${b.location ? ' ¬∑ ' + b.location : ''}`;

  const tagsEl = document.getElementById('detail-tags');
  tagsEl.innerHTML = (b.keywords || []).map(k => `<span class="tag">${escHtml(k)}</span>`).join('');

  // Check membership
  const { data: myMembership } = await sb.from('bubble_members')
    .select('id').eq('bubble_id', bubbleId).eq('user_id', currentUser.id).single();

  const joinArea = document.getElementById('bubble-join-area');
  const isOwner = b.created_by === currentUser.id;
  if (myMembership) {
    joinArea.innerHTML = `
      ${isOwner ? `<button class="btn-sm btn-ghost" onclick="openEditBubble('${b.id}')" style="font-size:0.85rem">‚úèÔ∏è</button>` : ''}
      ${isOwner ? `<button class="btn-sm btn-ghost" onclick="openQRModal('${b.id}')" style="font-size:0.85rem">‚¨õ</button>` : ''}
      <button class="btn-sm btn-accent" onclick="openBubbleChat('${b.id}')">üí¨ Chat</button>
      <button class="btn-sm btn-ghost" onclick="leaveBubble('${b.id}')">Forlad</button>`;
  } else if (b.visibility === 'hidden') {
    joinArea.innerHTML = `<span style="font-size:0.8rem;color:var(--muted)">üëÅÔ∏è Kun via invitation</span>`;
  } else if (b.visibility === 'private') {
    joinArea.innerHTML = `<button class="btn-sm btn-accent" onclick="requestJoin('${b.id}')">Anmod om adgang üîí</button>`;
  } else {
    joinArea.innerHTML = `<button class="btn-sm btn-accent" onclick="joinBubble('${b.id}')">+ Join</button>`;
  }

  // Load members with match scores
  await loadBubbleMembers(bubbleId);
}

async function loadBubbleMembers(bubbleId) {
  const { data: members } = await sb.from('bubble_members')
    .select('user_id, profiles(id, name, title, keywords, is_anon)')
    .eq('bubble_id', bubbleId).neq('user_id', currentUser.id);

  const list = document.getElementById('bubble-members-list');

  // Stats
  const { count } = await sb.from('bubble_members').select('*',{count:'exact',head:true}).eq('bubble_id',bubbleId);
  document.getElementById('detail-stats').innerHTML = `
    <div class="stat-box"><div class="stat-num">${count||0}</div><div class="stat-label">Aktive</div></div>
    <div class="stat-box"><div class="stat-num">${members?.length||0}</div><div class="stat-label">Andre</div></div>
    <div class="stat-box"><div class="stat-num" style="color:var(--accent3)">${members?.length ? Math.round(60 + Math.random()*35) : 0}%</div><div class="stat-label">Din match-rate</div></div>`;

  if (!members || members.length === 0) {
    list.innerHTML = '<div class="empty-state"><div class="empty-icon">üë•</div><div class="empty-text">Ingen andre i boblen endnu.</div></div>';
    return;
  }

  const myKw = (currentProfile?.keywords || []).map(k => k.toLowerCase());
  const scored = members.map(m => {
    const p = m.profiles;
    if (!p) return null;
    const theirKw = (p.keywords || []).map(k => k.toLowerCase());
    const overlap = myKw.filter(k => theirKw.includes(k));
    const score = theirKw.length ? Math.round((overlap.length / Math.max(myKw.length, theirKw.length, 1)) * 100 + 40 + Math.random()*20) : Math.round(40 + Math.random()*30);
    return { ...p, score: Math.min(score, 99), overlap };
  }).filter(Boolean).sort((a,b) => b.score - a.score);

  list.innerHTML = scored.map(p => {
    const initials = p.is_anon ? '?' : (p.name||'?').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
    const name = p.is_anon ? 'Anonym bruger' : escHtml(p.name || '?');
    const role = p.is_anon ? '' : escHtml(p.title || '');
    const colors = ['linear-gradient(135deg,#6c63ff,#8b83ff)','linear-gradient(135deg,#ff6584,#ffb347)','linear-gradient(135deg,#43e8b0,#6c63ff)','linear-gradient(135deg,#ffb347,#ff6584)'];
    const col = colors[Math.abs(p.id.charCodeAt(0)) % colors.length];
    return `<div class="card" style="display:flex;align-items:center;gap:0.85rem" onclick="openPerson('${p.id}','screen-bubble-detail')">
      <div class="avatar" style="background:${col}">${initials}</div>
      <div style="flex:1">
        <div style="font-weight:600;font-size:0.9rem">${name}</div>
        <div style="font-size:0.75rem;color:var(--muted)">${role}</div>
        <div class="match-bar-wrap"><div class="match-bar" style="width:${p.score}%"></div></div>
      </div>
      <div style="font-size:0.8rem;font-weight:700;color:var(--accent3)">${p.score}%</div>
    </div>`;
  }).join('');
}

async function joinBubble(bubbleId) {
  const { error } = await sb.from('bubble_members').insert({ bubble_id: bubbleId, user_id: currentUser.id });
  if (error && !error.message.includes('duplicate')) return showToast('Fejl ved joining');
  showToast('Du er nu i boblen! ü´ß');
  await openBubble(bubbleId);
  loadHome();
}

async function leaveBubble(bubbleId) {
  await sb.from('bubble_members').delete().eq('bubble_id', bubbleId).eq('user_id', currentUser.id);
  showToast('Du har forladt boblen');
  goTo('screen-home');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PERSON PROFILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openPerson(userId, fromScreen) {
  currentPerson = userId;
  const backBtn = document.getElementById('person-back-btn');
  backBtn.onclick = () => goTo(fromScreen || 'screen-home');
  goTo('screen-person');

  const { data: p } = await sb.from('profiles').select('*').eq('id', userId).single();
  if (!p) return;

  const initials = p.is_anon ? '?' : (p.name||'?').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
  document.getElementById('person-avatar').textContent = initials;
  document.getElementById('person-name').textContent = p.is_anon ? 'Anonym bruger' : (p.name || '?');
  document.getElementById('person-role').textContent = p.is_anon ? '' : (p.title || '');

  const myKw = (currentProfile?.keywords || []).map(k => k.toLowerCase());
  const theirKw = (p.keywords || []).map(k => k.toLowerCase());
  const overlap = myKw.filter(k => theirKw.includes(k));
  const score = theirKw.length ? Math.round((overlap.length / Math.max(myKw.length, theirKw.length, 1)) * 100 + 40 + Math.random()*20) : Math.round(40 + Math.random()*30);
  document.getElementById('person-match-label').textContent = `Match: ${Math.min(score,99)}%`;

  document.getElementById('person-tags').innerHTML = (p.keywords||[]).map(k => `<span class="tag">${escHtml(k)}</span>`).join('');
  document.getElementById('person-bio').textContent = p.bio || '';

  // LinkedIn button
  const liBtn = document.getElementById('person-linkedin-btn');
  if (p.linkedin && !p.is_anon) {
    liBtn.style.display = 'flex';
    liBtn.href = p.linkedin.startsWith('http') ? p.linkedin : 'https://' + p.linkedin;
  } else {
    liBtn.style.display = 'none';
  }

  const overlapEl = document.getElementById('person-overlap');
  if (overlap.length) {
    overlapEl.innerHTML = overlap.map(k => `<span class="tag mint">‚úì ${escHtml(k)}</span>`).join('');
  } else {
    overlapEl.innerHTML = '<span style="font-size:0.85rem;color:var(--muted)">Ingen direkte overlap fundet</span>';
  }

  const dynEl = document.getElementById('person-dynamic-keywords');
  if ((p.dynamic_keywords||[]).length) {
    dynEl.innerHTML = '<div class="section-label">S√∏ger nu</div>' + p.dynamic_keywords.map(k => `<span class="tag gold">üî• ${escHtml(k)}</span>`).join('');
  } else { dynEl.innerHTML = ''; }

  // Check if saved
  const { data: saved } = await sb.from('saved_contacts').select('id').eq('user_id', currentUser.id).eq('contact_id', userId).single();
  document.getElementById('save-btn').textContent = saved ? '‚úÖ Gemt' : 'üîñ Gem';
}

async function saveContact() {
  if (!currentPerson) return;
  const { data: existing } = await sb.from('saved_contacts').select('id').eq('user_id', currentUser.id).eq('contact_id', currentPerson).single();
  if (existing) { showToast('Allerede gemt'); return; }
  await sb.from('saved_contacts').insert({ user_id: currentUser.id, contact_id: currentPerson });
  document.getElementById('save-btn').querySelector('.btn-icon').textContent = '‚úÖ';
  showToast('Kontakt gemt! üîñ');
}

function proposeMeeting() {
  document.getElementById('meeting-msg').value = '';
  openModal('modal-meeting');
}

async function sendMeetingProposal() {
  const msg = document.getElementById('meeting-msg').value.trim();
  const time = document.getElementById('meeting-time').value;
  if (!msg) return showToast('Skriv en besked');
  const fullMsg = `‚òï M√∏deanmodning${time ? '\nüìÖ ' + new Date(time).toLocaleString('da-DK') : ''}\n\n${msg}`;
  await sendDirectMessage(currentPerson, fullMsg);
  closeModal('modal-meeting');
  showToast('M√∏deanmodning sendt! ‚òï');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MESSAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function updateUnreadBadge() {
  const { count } = await sb.from('messages')
    .select('*', { count: 'exact', head: true })
    .eq('receiver_id', currentUser.id)
    .is('read_at', null);
  document.querySelectorAll('.msg-unread-badge').forEach(b => {
    if (count && count > 0) {
      b.textContent = count > 9 ? '9+' : count;
      b.style.display = 'flex';
    } else {
      b.style.display = 'none';
    }
  });
}

function subscribeToIncoming() {
  sb.channel('incoming-messages')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages',
      filter: `receiver_id=eq.${currentUser.id}` }, () => {
      updateUnreadBadge();
    }).subscribe();
}

async function loadMessages() {
  const list = document.getElementById('conversations-list');
  list.innerHTML = '<div class="spinner"></div>';

  const { data: convs } = await sb.from('messages')
    .select('*')
    .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
    .order('created_at', {ascending:false});

  if (!convs || convs.length === 0) {
    list.innerHTML = '<div class="empty-state"><div class="empty-icon">üí¨</div><div class="empty-text">Ingen beskeder endnu.<br>Find en person og start en samtale!</div></div>';
    return;
  }

  // Get unique conversation partners
  const seen = new Set();
  const partners = [];
  for (const m of convs) {
    const partnerId = m.sender_id === currentUser.id ? m.receiver_id : m.sender_id;
    if (!seen.has(partnerId)) {
      seen.add(partnerId);
      partners.push({ partnerId, lastMsg: m });
    }
  }

  // Load partner profiles
  const pIds = partners.map(p => p.partnerId);
  const { data: profiles } = await sb.from('profiles').select('id,name,title').in('id', pIds);
  const profileMap = Object.fromEntries((profiles||[]).map(p=>[p.id,p]));

  list.innerHTML = partners.map(({ partnerId, lastMsg }) => {
    const p = profileMap[partnerId] || {};
    const initials = (p.name||'?').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
    const isUnread = lastMsg.receiver_id === currentUser.id && !lastMsg.read_at;
    return `<div class="card" style="display:flex;align-items:center;gap:0.85rem" onclick="openChat('${partnerId}')">
      <div class="avatar" style="background:linear-gradient(135deg,#6c63ff,#ff6584)">${initials}</div>
      <div style="flex:1">
        <div style="font-weight:${isUnread?'700':'600'};font-size:0.9rem;color:${isUnread?'var(--text)':'var(--text)'}">${escHtml(p.name||'Ukendt')}</div>
        <div style="font-size:0.78rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px">${escHtml(lastMsg.content||'')}</div>
      </div>
      ${isUnread ? '<div class="live-dot"></div>' : ''}
    </div>`;
  }).join('');
}

async function openChat(userId) {
  currentChatUser = userId;
  const { data: p } = await sb.from('profiles').select('name,title').eq('id', userId).single();
  document.getElementById('chat-name').textContent = p?.name || 'Ukendt';
  document.getElementById('chat-role').textContent = p?.title || '';
  goTo('screen-chat');
  await loadChatMessages();
  subscribeToChat();

  // Mark messages as read
  await sb.from('messages').update({ read_at: new Date().toISOString() })
    .eq('sender_id', userId).eq('receiver_id', currentUser.id).is('read_at', null);
  await updateUnreadBadge();
}

async function loadChatMessages() {
  const el = document.getElementById('chat-messages');
  const { data: msgs } = await sb.from('messages')
    .select('*')
    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${currentChatUser}),and(sender_id.eq.${currentChatUser},receiver_id.eq.${currentUser.id})`)
    .order('created_at', {ascending:true});

  el.innerHTML = (msgs||[]).map(m => {
    const sent = m.sender_id === currentUser.id;
    const time = new Date(m.created_at).toLocaleTimeString('da-DK', {hour:'2-digit',minute:'2-digit'});
    return `<div style="display:flex;flex-direction:column;align-items:${sent?'flex-end':'flex-start'}">
      <div class="msg-bubble ${sent?'sent':'recv'}">${escHtml(m.content||'')}</div>
      <div class="msg-time" style="text-align:${sent?'right':'left'}">${time}</div>
    </div>`;
  }).join('');
  el.scrollTop = el.scrollHeight;
}

function subscribeToChat() {
  if (chatSubscription) chatSubscription.unsubscribe();
  chatSubscription = sb.channel('chat-' + currentChatUser)
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, () => {
      loadChatMessages();
    }).subscribe();
}

async function sendMessage() {
  const input = document.getElementById('chat-input');
  const content = input.value.trim();
  if (!content) return;
  input.value = '';
  await sendDirectMessage(currentChatUser, content);
  await loadChatMessages();
}

async function sendDirectMessage(toId, content) {
  await sb.from('messages').insert({
    sender_id: currentUser.id,
    receiver_id: toId,
    content
  });
}

function startChat() {
  if (!currentPerson) return;
  openChat(currentPerson);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROFILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadProfile() {
  if (!currentProfile) await loadCurrentProfile();
  if (!currentProfile) return;

  const initials = (currentProfile.name||'?').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
  document.getElementById('my-avatar').textContent = initials;
  document.getElementById('my-name').textContent = currentProfile.name || '...';
  document.getElementById('my-role').textContent = currentProfile.title || '';
  document.getElementById('my-keywords').innerHTML = (currentProfile.keywords||[]).map(k=>`<span class="tag">${escHtml(k)}</span>`).join('');

  isAnon = currentProfile.is_anon || false;
  updateAnonToggle();

  // Saved contacts
  const { data: saved } = await sb.from('saved_contacts')
    .select('contact_id, profiles(id,name,title)').eq('user_id', currentUser.id);
  const savedEl = document.getElementById('saved-contacts');
  if (saved && saved.length) {
    savedEl.innerHTML = saved.map(s => {
      const p = s.profiles;
      if (!p) return '';
      const ini = (p.name||'?').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
      return `<div style="display:flex;flex-direction:column;align-items:center;gap:0.35rem;cursor:pointer" onclick="openPerson('${p.id}','screen-profile')">
        <div class="avatar" style="background:linear-gradient(135deg,#6c63ff,#ff6584);width:48px;height:48px;font-size:0.85rem">${ini}</div>
        <div style="font-size:0.65rem;color:var(--muted);text-align:center;max-width:56px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escHtml(p.name?.split(' ')[0]||'?')}</div>
      </div>`;
    }).join('');
  } else {
    savedEl.innerHTML = '<div style="font-size:0.85rem;color:var(--muted)">Ingen gemte kontakter endnu</div>';
  }

  await loadMyBubbles();
}

function openEditProfile() {
  if (!currentProfile) return;
  document.getElementById('ep-name').value = currentProfile.name || '';
  document.getElementById('ep-title').value = currentProfile.title || '';
  document.getElementById('ep-bio').value = currentProfile.bio || '';
  epChips = [...(currentProfile.keywords || [])];
  epDynChips = [...(currentProfile.dynamic_keywords || [])];
  renderChips('ep-chips', epChips, 'ep-chips-container', 'ep-chip-input');
  renderChips('ep-dyn-chips', epDynChips, 'ep-dyn-chips-container', 'ep-dyn-chip-input');
  openModal('modal-edit-profile');
}

async function saveProfile() {
  const name  = document.getElementById('ep-name').value.trim();
  const title = document.getElementById('ep-title').value.trim();
  const bio   = document.getElementById('ep-bio').value.trim();
  if (!name) return showToast('Navn er p√•kr√¶vet');
  const { error } = await sb.from('profiles').upsert({
    id: currentUser.id, name, title, bio,
    keywords: epChips, dynamic_keywords: epDynChips, is_anon: isAnon
  });
  if (error) return showToast('Fejl: ' + error.message);
  await loadCurrentProfile();
  closeModal('modal-edit-profile');
  loadProfile();
  showToast('Profil gemt! ‚úÖ');
}

function toggleAnon() {
  isAnon = !isAnon;
  updateAnonToggle();
  sb.from('profiles').update({ is_anon: isAnon }).eq('id', currentUser.id).then();
}

function updateAnonToggle() {
  const toggle = document.getElementById('anon-toggle');
  const knob = document.getElementById('anon-knob');
  toggle.style.background = isAnon ? 'var(--accent)' : 'var(--border)';
  knob.style.background = isAnon ? 'white' : 'var(--muted)';
  knob.style.left = isAnon ? '23px' : '3px';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CREATE BUBBLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openCreateBubble() {
  cbChips = [];
  document.getElementById('cb-name').value = '';
  document.getElementById('cb-desc').value = '';
  document.getElementById('cb-location').value = '';
  renderChips('cb-chips', cbChips, 'cb-chips-container', 'cb-chip-input');
  openModal('modal-create-bubble');
}

async function createBubble() {
  const name = document.getElementById('cb-name').value.trim();
  const type = document.getElementById('cb-type').value;
  const desc = document.getElementById('cb-desc').value.trim();
  const location = document.getElementById('cb-location').value.trim();
  if (!name) return showToast('Navn er p√•kr√¶vet');
  const visibility = document.getElementById('cb-visibility')?.value || 'public';
  const { data: bubble, error } = await sb.from('bubbles').insert({
    name, type, type_label: typeLabel(type), description: desc, location,
    keywords: cbChips, created_by: currentUser.id, visibility
  }).select().single();
  if (error) return showToast('Fejl: ' + error.message);
  // Auto-join
  await sb.from('bubble_members').insert({ bubble_id: bubble.id, user_id: currentUser.id });
  closeModal('modal-create-bubble');
  showToast(`"${name}" oprettet! ü´ß`);
  loadHome();
  loadDiscover();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHIP INPUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleChipInput(e, arrayName) {
  if (e.key === 'Enter' || e.key === ',') {
    e.preventDefault();
    const val = e.target.value.trim().replace(/,/g,'');
    if (!val) return;
    const arr = arrayName === 'cb-chips' ? cbChips : arrayName === 'ep-chips' ? epChips : arrayName === 'eb-chips' ? ebChips : arrayName === 'ob-chips' ? obChips : epDynChips;
    const containerId = arrayName === 'cb-chips' ? 'cb-chips-container' : arrayName === 'ep-chips' ? 'ep-chips-container' : arrayName === 'eb-chips' ? 'eb-chips-container' : arrayName === 'ob-chips' ? 'ob-chips-container' : 'ep-dyn-chips-container';
    const inputId = arrayName === 'cb-chips' ? 'cb-chip-input' : arrayName === 'ep-chips' ? 'ep-chip-input' : arrayName === 'eb-chips' ? 'eb-chip-input' : arrayName === 'ob-chips' ? 'ob-chip-input' : 'ep-dyn-chip-input';
    if (!arr.includes(val)) arr.push(val);
    e.target.value = '';
    renderChips(arrayName, arr, containerId, inputId);
  }
}

function renderChips(arrayName, arr, containerId, inputId) {
  const container = document.getElementById(containerId);
  const oldInput = document.getElementById(inputId);
  container.innerHTML = '';
  arr.forEach((chip, i) => {
    const span = document.createElement('div');
    span.className = 'chip';
    span.innerHTML = `${escHtml(chip)} <span class="chip-remove" onclick="removeChip('${arrayName}',${i},'${containerId}','${inputId}')">√ó</span>`;
    container.appendChild(span);
  });
  const input = document.createElement('input');
  input.className = 'chip-input';
  input.id = inputId;
  input.placeholder = arr.length ? '' : oldInput?.placeholder || 'Tilf√∏j...';
  input.onkeydown = (e) => handleChipInput(e, arrayName);
  container.appendChild(input);
}

function removeChip(arrayName, index, containerId, inputId) {
  const arr = arrayName === 'cb-chips' ? cbChips : arrayName === 'ep-chips' ? epChips : arrayName === 'eb-chips' ? ebChips : arrayName === 'ob-chips' ? obChips : epDynChips;
  arr.splice(index, 1);
  renderChips(arrayName, arr, containerId, inputId);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
// Close modal on backdrop click
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', (e) => { if (e.target === el) el.classList.remove('open'); });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function escHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function bubbleEmoji(type) {
  return { event:'üöÄ', local:'üìç', theme:'ü§ñ', company:'üè¢' }[type] || 'ü´ß';
}

function bubbleColor(type, alpha) {
  const map = { event:`rgba(108,99,255,${alpha})`, local:`rgba(67,232,176,${alpha})`, theme:`rgba(255,179,71,${alpha})`, company:`rgba(255,101,132,${alpha})` };
  return map[type] || `rgba(108,99,255,${alpha})`;
}

function typeLabel(type) {
  return { event:'Event', local:'Lokal', theme:'Tema', company:'Virksomhed' }[type] || type;
}

function updateClock() {
  const now = new Date();
  const t = now.toLocaleTimeString('da-DK', {hour:'2-digit',minute:'2-digit'});
  document.querySelectorAll('.status-bar span:first-child').forEach(el => el.textContent = t);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PRIVATE BUBBLE ‚Äî JOIN REQUEST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function requestJoin(bubbleId) {
  const { data: b } = await sb.from('bubbles').select('name,created_by').eq('id', bubbleId).single();
  const { error } = await sb.from('bubble_members').insert({
    bubble_id: bubbleId, user_id: currentUser.id, status: 'pending'
  });
  if (error && !error.message.includes('duplicate')) return showToast('Fejl: ' + error.message);
  showToast('Anmodning sendt! Ejeren skal godkende üîí');
  await openBubble(bubbleId);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EDIT BUBBLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentEditBubbleId = null;

async function openEditBubble(bubbleId) {
  currentEditBubbleId = bubbleId;
  const { data: b } = await sb.from('bubbles').select('*').eq('id', bubbleId).single();
  if (!b) return;
  document.getElementById('eb-name').value = b.name || '';
  document.getElementById('eb-type').value = b.type || 'event';
  document.getElementById('eb-visibility').value = b.visibility || 'public';
  document.getElementById('eb-desc').value = b.description || '';
  document.getElementById('eb-location').value = b.location || '';
  ebChips = [...(b.keywords || [])];
  renderChips('eb-chips', ebChips, 'eb-chips-container', 'eb-chip-input');
  openModal('modal-edit-bubble');
}

async function saveEditBubble() {
  const name       = document.getElementById('eb-name').value.trim();
  const type       = document.getElementById('eb-type').value;
  const visibility = document.getElementById('eb-visibility').value;
  const desc       = document.getElementById('eb-desc').value.trim();
  const location   = document.getElementById('eb-location').value.trim();
  if (!name) return showToast('Navn er p√•kr√¶vet');
  const { error } = await sb.from('bubbles').update({
    name, type, type_label: typeLabel(type),
    visibility, description: desc, location, keywords: ebChips
  }).eq('id', currentEditBubbleId);
  if (error) return showToast('Fejl: ' + error.message);
  closeModal('modal-edit-bubble');
  showToast('Boble opdateret! ‚úÖ');
  await openBubble(currentEditBubbleId);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  QR CODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentQRBubble = null;

async function openQRModal(bubbleId) {
  currentQRBubble = bubbleId;
  const { data: b } = await sb.from('bubbles').select('*').eq('id', bubbleId).single();
  if (!b) return;

  document.getElementById('qr-modal-title').textContent = b.name + ' ü´ß';
  document.getElementById('qr-modal-subtitle').textContent =
    `${typeLabel(b.type)}${b.location ? ' ¬∑ ' + b.location : ''} ‚Äî scan for at joine`;

  // Build the join URL ‚Äî opens app and auto-joins the bubble
  const joinUrl = `${window.location.origin}${window.location.pathname}?join=${bubbleId}`;

  // Clear and render QR
  const el = document.getElementById('qr-code-el');
  el.innerHTML = '';
  new QRCode(el, {
    text: joinUrl,
    width: 220,
    height: 220,
    colorDark: '#0a0a0f',
    colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.H
  });

  openModal('modal-qr');
}

async function downloadQRPdf() {
  const { data: b } = await sb.from('bubbles').select('*').eq('id', currentQRBubble).single();
  if (!b) return;

  showToast('Genererer PDF...');

  // Wait a tick for QR to render fully
  await new Promise(r => setTimeout(r, 300));

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

  const pageW = 210, pageH = 297;

  // Dark background
  doc.setFillColor(10, 10, 15);
  doc.rect(0, 0, pageW, pageH, 'F');

  // Purple accent top bar
  doc.setFillColor(108, 99, 255);
  doc.rect(0, 0, pageW, 8, 'F');

  // Bubble logo area (purple rounded rect simulation)
  doc.setFillColor(108, 99, 255);
  doc.roundedRect(pageW/2 - 18, 28, 36, 36, 6, 6, 'F');

  // Bubble text in logo
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(22);
  doc.text('ü´ß', pageW/2, 51, { align: 'center' });

  // App name
  doc.setFontSize(28);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(240, 240, 248);
  doc.text('bubble', pageW/2, 82, { align: 'center' });

  // Tagline
  doc.setFontSize(11);
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(108, 108, 138);
  doc.text('Network Radar for Business', pageW/2, 91, { align: 'center' });

  // Divider
  doc.setDrawColor(42, 42, 61);
  doc.setLineWidth(0.5);
  doc.line(20, 99, pageW - 20, 99);

  // Bubble name
  doc.setFontSize(22);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(240, 240, 248);
  doc.text(b.name, pageW/2, 115, { align: 'center' });

  // Type + location
  doc.setFontSize(12);
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(108, 108, 138);
  const meta = typeLabel(b.type) + (b.location ? ' ¬∑ ' + b.location : '');
  doc.text(meta, pageW/2, 124, { align: 'center' });

  // Keywords
  if (b.keywords && b.keywords.length) {
    doc.setFontSize(10);
    doc.setTextColor(108, 99, 255);
    doc.text(b.keywords.slice(0,5).join('  ¬∑  '), pageW/2, 133, { align: 'center' });
  }

  // QR code ‚Äî get canvas from DOM
  const qrCanvas = document.querySelector('#qr-code-el canvas') ||
                   document.querySelector('#qr-code-el img');

  if (qrCanvas) {
    let imgData;
    if (qrCanvas.tagName === 'CANVAS') {
      imgData = qrCanvas.toDataURL('image/png');
    } else {
      // It's an img tag ‚Äî draw to canvas first
      const tmpCanvas = document.createElement('canvas');
      tmpCanvas.width = 220; tmpCanvas.height = 220;
      tmpCanvas.getContext('2d').drawImage(qrCanvas, 0, 0);
      imgData = tmpCanvas.toDataURL('image/png');
    }

    // White background behind QR
    const qrSize = 80;
    const qrX = (pageW - qrSize) / 2;
    const qrY = 145;
    doc.setFillColor(255, 255, 255);
    doc.roundedRect(qrX - 6, qrY - 6, qrSize + 12, qrSize + 12, 4, 4, 'F');
    doc.addImage(imgData, 'PNG', qrX, qrY, qrSize, qrSize);
  }

  // Scan instruction
  doc.setFontSize(13);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(240, 240, 248);
  doc.text('Scan og join boblen', pageW/2, 245, { align: 'center' });

  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(108, 108, 138);
  doc.text('√Öbn iPhone-kameraet og ret det mod QR-koden', pageW/2, 253, { align: 'center' });
  doc.text('Du bliver automatisk tilf√∏jet til boblen', pageW/2, 260, { align: 'center' });

  // Bottom accent
  doc.setFillColor(108, 99, 255);
  doc.rect(0, pageH - 8, pageW, 8, 'F');

  // Save
  const filename = `bubble-qr-${b.name.toLowerCase().replace(/\s+/g,'-')}.pdf`;
  doc.save(filename);
  showToast('PDF downloadet! üñ®Ô∏è');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTO-JOIN VIA QR SCAN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function checkQRJoin() {
  const params = new URLSearchParams(window.location.search);
  const joinId = params.get('join');
  if (!joinId) return;

  // Clean URL
  window.history.replaceState({}, '', window.location.pathname);

  // Wait for auth
  const { data: { session } } = await sb.auth.getSession();
  if (!session) {
    // Save for after login
    sessionStorage.setItem('pending_join', joinId);
    return;
  }

  // Auto-join
  const { error } = await sb.from('bubble_members')
    .insert({ bubble_id: joinId, user_id: session.user.id });

  if (!error || error.message.includes('duplicate')) {
    showToast('Du er checket ind! ü´ß');
    await openBubble(joinId, 'screen-home');
  }
}

async function checkPendingJoin() {
  const joinId = sessionStorage.getItem('pending_join');
  if (!joinId) return;
  sessionStorage.removeItem('pending_join');
  const { error } = await sb.from('bubble_members')
    .insert({ bubble_id: joinId, user_id: currentUser.id });
  if (!error || error.message.includes('duplicate')) {
    showToast('Du er checket ind! ü´ß');
    await openBubble(joinId, 'screen-home');
  }
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ONBOARDING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function maybeShowOnboarding() {
  if (!currentProfile ||
      !currentProfile.name ||
      currentProfile.name === currentProfile.id ||
      currentProfile.name === currentUser.email ||
      !currentProfile.title ||
      !currentProfile.keywords ||
      currentProfile.keywords.length === 0) {
    // Pre-fill name from Google if available
    const googleName = currentUser.user_metadata?.full_name ||
                       currentUser.user_metadata?.name || '';
    if (googleName) document.getElementById('ob-name').value = googleName;
    else document.getElementById('ob-name').value = currentProfile?.name || '';
    document.getElementById('ob-title').value = currentProfile?.title || '';
    document.getElementById('ob-bio').value = currentProfile?.bio || '';
    document.getElementById('ob-linkedin').value = currentProfile?.linkedin || '';
    obChips = [...(currentProfile?.keywords || [])];
    renderChips('ob-chips', obChips, 'ob-chips-container', 'ob-chip-input');
    goTo('screen-onboarding');
    return true;
  }
  return false;
}

async function saveOnboarding() {
  const name     = document.getElementById('ob-name').value.trim();
  const title    = document.getElementById('ob-title').value.trim();
  const bio      = document.getElementById('ob-bio').value.trim();
  const linkedin = document.getElementById('ob-linkedin').value.trim();
  if (!name)            return showToast('Navn er p√•kr√¶vet');
  if (!title)           return showToast('Titel er p√•kr√¶vet');
  if (obChips.length === 0) return showToast('Tilf√∏j mindst √©t n√∏gleord');
  const { error } = await sb.from('profiles').upsert({
    id: currentUser.id, name, title, bio, linkedin,
    keywords: obChips, dynamic_keywords: [], is_anon: false
  });
  if (error) return showToast('Fejl: ' + error.message);
  await loadCurrentProfile();
  showToast('Profil oprettet! üéâ');
  goTo('screen-home');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GOOGLE LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function handleGoogleLogin() {
  const { error } = await sb.auth.signInWithOAuth({
    provider: 'google',
    options: {
      redirectTo: 'https://michaelatsorensen.github.io/bubble_pwa',
      queryParams: { access_type: 'offline', prompt: 'consent' }
    }
  });
  if (error) showToast('Google login fejl: ' + error.message);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadNotifications() {
  const list = document.getElementById('notifications-list');
  if (!list) return;
  list.innerHTML = '<div class="spinner"></div>';

  let html = '';

  // 1. Bubble-up invitations pending
  const { data: invites } = await sb.from('bubble_invitations')
    .select('id, from_user_id, bubble_id, created_at, profiles!bubble_invitations_from_user_id_fkey(name,title)')
    .eq('to_user_id', currentUser.id)
    .eq('status', 'pending')
    .order('created_at', {ascending:false});

  if (invites && invites.length > 0) {
    invites.forEach(inv => {
      const p = inv.profiles || {};
      const initials = (p.name||'?').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
      html += `<div class="notif-card invite" id="invite-${inv.id}">
        <div class="notif-header">
          <div class="notif-avatar" style="background:linear-gradient(135deg,#6c63ff,#ff6584)">${initials}</div>
          <div>
            <div class="notif-title">ü´ß Bubble up invitation</div>
            <div class="notif-sub">${escHtml(p.name||'Nogen')} vil oprette en privat boble med dig</div>
          </div>
        </div>
        <div class="notif-actions">
          <button class="notif-btn accept" onclick="acceptBubbleInvite('${inv.id}','${inv.from_user_id}')">Accepter</button>
          <button class="notif-btn decline" onclick="declineBubbleInvite('${inv.id}')">Afvis</button>
        </div>
      </div>`;
    });
  }

  // 2. New members in my bubbles
  const { data: memberships } = await sb.from('bubble_members').select('bubble_id').eq('user_id', currentUser.id);
  if (memberships && memberships.length > 0) {
    const ids = memberships.map(m => m.bubble_id);
    const since = new Date(Date.now() - 30*24*60*60*1000).toISOString();
    const { data: newMembers } = await sb.from('bubble_members')
      .select('user_id, joined_at, bubble_id, bubbles(name)')
      .in('bubble_id', ids).neq('user_id', currentUser.id)
      .gte('joined_at', since).order('joined_at', {ascending:false}).limit(20);

    if (newMembers && newMembers.length > 0) {
      const userIds = [...new Set(newMembers.map(m => m.user_id))];
      const { data: profiles } = await sb.from('profiles').select('id,name').in('id', userIds);
      const pMap = Object.fromEntries((profiles||[]).map(p=>[p.id,p]));
      newMembers.forEach(m => {
        const p = pMap[m.user_id] || {};
        const initials = (p.name||'?').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
        const time = new Date(m.joined_at).toLocaleDateString('da-DK', {day:'numeric',month:'short'});
        html += `<div class="notif-card">
          <div class="notif-header">
            <div class="notif-avatar" style="background:linear-gradient(135deg,#43e8b0,#6c63ff)">${initials}</div>
            <div>
              <div class="notif-title">${escHtml(p.name||'Ukendt')} joined</div>
              <div class="notif-sub">${escHtml(m.bubbles?.name||'')} ¬∑ ${time}</div>
            </div>
          </div>
        </div>`;
      });
    }
  }

  if (!html) {
    html = '<div class="empty-state"><div class="empty-icon">üîî</div><div class="empty-text">Ingen notifikationer endnu</div></div>';
  }
  list.innerHTML = html;
}

async function acceptBubbleInvite(inviteId, fromUserId) {
  // Update invitation status
  await sb.from('bubble_invitations').update({status:'accepted'}).eq('id', inviteId);
  // Get the bubble_id from invitation
  const { data: inv } = await sb.from('bubble_invitations').select('bubble_id').eq('id', inviteId).single();
  if (inv?.bubble_id) {
    // Add to bubble_members
    await sb.from('bubble_members').insert({bubble_id: inv.bubble_id, user_id: currentUser.id});
    showToast('ü´ß Du er nu med i boblen!');
    loadNotifications();
    // Open the bubble chat
    setTimeout(() => openBubbleChat(inv.bubble_id), 800);
  }
}

async function declineBubbleInvite(inviteId) {
  await sb.from('bubble_invitations').update({status:'declined'}).eq('id', inviteId);
  document.getElementById('invite-' + inviteId)?.remove();
  showToast('Invitation afvist');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOBLE CHAT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let bcBubbleId = null;
let bcCurrentMsgId = null;
let bcEditingId = null;
let bcMsgHistories = {};
let bcSubscription = null;
let bcBubbleData = null;

async function openBubbleChat(bubbleId) {
  bcBubbleId = bubbleId;
  const backBtn = document.getElementById('bc-back-btn');
  backBtn.onclick = () => goTo('screen-bubble-detail');
  goTo('screen-bubble-chat');
  bcSwitchTab('chat');
  await bcLoadBubbleInfo();
  await bcLoadMessages();
  bcSubscribe();
}

async function bcLoadBubbleInfo() {
  const { data: b } = await sb.from('bubbles').select('*').eq('id', bcBubbleId).single();
  if (!b) return;
  bcBubbleData = b;
  document.getElementById('bc-emoji').textContent = bubbleEmoji(b.type);
  document.getElementById('bc-name').textContent = b.name;
  const { count } = await sb.from('bubble_members').select('*',{count:'exact',head:true}).eq('bubble_id', bcBubbleId);
  document.getElementById('bc-members-count').textContent = (count||0) + ' medlemmer';
}

function bcSwitchTab(tab) {
  ['chat','members','info'].forEach(t => {
    document.getElementById('bc-panel-'+t).style.display = t === tab ? 'flex' : 'none';
    document.getElementById('bc-panel-'+t).style.flexDirection = 'column';
    document.getElementById('bc-panel-'+t).style.flex = '1';
    document.getElementById('bc-panel-'+t).style.overflow = 'hidden';
    document.getElementById('bc-tab-'+t).classList.toggle('active', t === tab);
  });
  if (tab === 'chat') {
    document.getElementById('bc-unread-badge').style.display = 'none';
    setTimeout(() => bcScrollToBottom(), 100);
  }
  if (tab === 'members') bcLoadMembers();
  if (tab === 'info') bcLoadInfo();
}

async function bcLoadMessages() {
  const el = document.getElementById('bc-messages');
  el.innerHTML = '<div class="spinner"></div>';

  const { data: msgs } = await sb.from('bubble_messages')
    .select('*, profiles(id, name)')
    .eq('bubble_id', bcBubbleId)
    .order('created_at', {ascending:true})
    .limit(50);

  if (!msgs || msgs.length === 0) {
    el.innerHTML = '<div class="empty-state" style="margin-top:2rem"><div class="empty-icon">üí¨</div><div class="empty-text">Ingen beskeder endnu.<br>V√¶r den f√∏rste!</div></div>';
    return;
  }

  el.innerHTML = '';
  let lastDate = '';
  msgs.forEach(m => {
    const d = new Date(m.created_at).toLocaleDateString('da-DK', {weekday:'long', day:'numeric', month:'short'});
    if (d !== lastDate) {
      const sep = document.createElement('div');
      sep.className = 'chat-date-sep';
      sep.textContent = d.toUpperCase();
      el.appendChild(sep);
      lastDate = d;
    }
    el.appendChild(bcRenderMsg(m));
  });
  bcScrollToBottom();
}

function bcRenderMsg(m) {
  const isMe = m.user_id === currentUser.id;
  const p = m.profiles || {};
  const initials = (p.name||'?').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
  const time = new Date(m.created_at).toLocaleTimeString('da-DK', {hour:'2-digit', minute:'2-digit'});
  const colors = ['linear-gradient(135deg,#065F46,#10B981)','linear-gradient(135deg,#7C2D12,#F97316)','linear-gradient(135deg,#1E3A8A,#7C3AED)','linear-gradient(135deg,#4C1D95,#A78BFA)','linear-gradient(135deg,#0C4A6E,#38BDF8)'];
  const color = colors[Math.abs((p.name||'?').charCodeAt(0)) % colors.length];

  const g = document.createElement('div');
  g.className = 'chat-msg-group ' + (isMe ? 'me' : 'them');
  g.id = 'bc-msg-' + m.id;
  g.dataset.msgId = m.id;
  g.dataset.isMe = isMe;

  if (m.file_url) {
    const ext = m.file_name?.split('.').pop()?.toLowerCase() || '';
    const icon = ['pdf'].includes(ext) ? 'üìÑ' : ['jpg','jpeg','png','gif','webp'].includes(ext) ? 'üñºÔ∏è' : ['zip','rar'].includes(ext) ? 'üóúÔ∏è' : 'üìé';
    const size = m.file_size ? (m.file_size < 1024*1024 ? Math.round(m.file_size/1024)+'KB' : (m.file_size/1024/1024).toFixed(1)+'MB') : '';
    g.innerHTML = `
      ${!isMe ? `<div class="chat-msg-avatar-row"><div class="chat-msg-avatar" style="background:${color}" onclick="bcOpenPerson('${m.user_id}','${p.name||''}','${p.title||''}','${color}')">${initials}</div><span class="chat-msg-sender">${escHtml(p.name||'')}</span></div>` : ''}
      <div class="chat-msg-wrap">
        ${isMe ? `<button class="chat-msg-actions" onclick="bcOpenContext(event,this,true,'${m.id}')">‚ãØ</button>` : ''}
        <a class="chat-file-bubble" href="${m.file_url}" target="_blank" rel="noopener">
          <span class="chat-file-icon">${icon}</span>
          <div><div class="chat-file-name">${escHtml(m.file_name||'Fil')}</div><div class="chat-file-size">${size}</div></div>
        </a>
        ${!isMe ? `<button class="chat-msg-actions" onclick="bcOpenContext(event,this,false,'${m.id}')">‚ãØ</button>` : ''}
      </div>
      <div class="chat-msg-meta"><span class="chat-msg-time">${time}</span></div>`;
  } else {
    g.innerHTML = `
      ${!isMe ? `<div class="chat-msg-avatar-row"><div class="chat-msg-avatar" style="background:${color}" onclick="bcOpenPerson('${m.user_id}','${p.name||''}','${p.title||''}','${color}')">${initials}</div><span class="chat-msg-sender">${escHtml(p.name||'')}</span></div>` : ''}
      <div class="chat-msg-wrap">
        ${isMe ? `<button class="chat-msg-actions" onclick="bcOpenContext(event,this,true,'${m.id}')">‚ãØ</button>` : ''}
        <div class="chat-bubble" id="bc-bubble-${m.id}">${escHtml(m.content||'')}${m.edited ? '' : ''}</div>
        ${!isMe ? `<button class="chat-msg-actions" onclick="bcOpenContext(event,this,false,'${m.id}')">‚ãØ</button>` : ''}
      </div>
      <div class="chat-msg-meta">
        <span class="chat-msg-time">${time}</span>
        ${m.edited ? `<span class="chat-msg-edited" onclick="bcShowHistory('${m.id}')">(redigeret)</span>` : ''}
      </div>`;
  }
  return g;
}

function bcScrollToBottom() {
  const el = document.getElementById('bc-messages');
  if (el) el.scrollTop = el.scrollHeight;
}

function bcSubscribe() {
  if (bcSubscription) bcSubscription.unsubscribe();
  bcSubscription = sb.channel('bc-' + bcBubbleId)
    .on('postgres_changes', {event:'INSERT', schema:'public', table:'bubble_messages', filter:`bubble_id=eq.${bcBubbleId}`},
      async (payload) => {
        const m = payload.new;
        if (m.user_id === currentUser.id) return;
        const { data: p } = await sb.from('profiles').select('name,title').eq('id', m.user_id).single();
        m.profiles = p || {};
        const panel = document.getElementById('bc-panel-chat');
        if (panel.style.display !== 'none') {
          document.getElementById('bc-messages').appendChild(bcRenderMsg(m));
          bcScrollToBottom();
        } else {
          const badge = document.getElementById('bc-unread-badge');
          badge.textContent = parseInt(badge.textContent||0) + 1;
          badge.style.display = 'inline-flex';
        }
      })
    .on('postgres_changes', {event:'UPDATE', schema:'public', table:'bubble_messages', filter:`bubble_id=eq.${bcBubbleId}`},
      (payload) => {
        const m = payload.new;
        const bubbleEl = document.getElementById('bc-bubble-' + m.id);
        if (bubbleEl) {
          bubbleEl.textContent = m.content || '';
          const meta = bubbleEl.closest('.chat-msg-group')?.querySelector('.chat-msg-meta');
          if (meta && !meta.querySelector('.chat-msg-edited')) {
            const e = document.createElement('span');
            e.className = 'chat-msg-edited';
            e.textContent = '(redigeret)';
            e.onclick = () => bcShowHistory(m.id);
            meta.appendChild(e);
          }
        }
      })
    .subscribe();
}

async function bcSendMessage() {
  const inp = document.getElementById('bc-input');
  const text = inp.value.trim();
  if (!text) return;

  if (bcEditingId) {
    // Save edit to history first
    const { data: orig } = await sb.from('bubble_messages').select('content').eq('id', bcEditingId).single();
    if (orig) {
      await sb.from('bubble_message_edits').insert({message_id: bcEditingId, content: orig.content});
    }
    await sb.from('bubble_messages').update({content: text, edited: true, updated_at: new Date().toISOString()}).eq('id', bcEditingId);
    // Update local
    const bubbleEl = document.getElementById('bc-bubble-' + bcEditingId);
    if (bubbleEl) {
      bubbleEl.textContent = text;
      const meta = bubbleEl.closest('.chat-msg-group')?.querySelector('.chat-msg-meta');
      if (meta && !meta.querySelector('.chat-msg-edited')) {
        const e = document.createElement('span');
        e.className = 'chat-msg-edited';
        const id = bcEditingId;
        e.textContent = '(redigeret)';
        e.onclick = () => bcShowHistory(id);
        meta.appendChild(e);
      }
    }
    bcCancelEdit();
  } else {
    const { data: newMsg, error } = await sb.from('bubble_messages').insert({
      bubble_id: bcBubbleId,
      user_id: currentUser.id,
      content: text
    }).select('*, profiles(id,name)').single();

    if (!error && newMsg) {
      document.getElementById('bc-messages').appendChild(bcRenderMsg(newMsg));
      bcScrollToBottom();
    }
  }
  inp.value = '';
}

async function bcHandleFile(input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 10 * 1024 * 1024) { showToast('Maks 10MB per fil'); return; }

  showToast('Uploader...');
  const path = `bubble-files/${bcBubbleId}/${Date.now()}-${file.name}`;
  const { error: uploadErr } = await sb.storage.from('bubble-files').upload(path, file);
  if (uploadErr) {
    // Try creating bucket first
    await sb.storage.createBucket('bubble-files', {public: true});
    const { error: retry } = await sb.storage.from('bubble-files').upload(path, file);
    if (retry) { showToast('Upload fejlede'); return; }
  }
  const { data: urlData } = sb.storage.from('bubble-files').getPublicUrl(path);
  const { data: newMsg } = await sb.from('bubble_messages').insert({
    bubble_id: bcBubbleId,
    user_id: currentUser.id,
    file_url: urlData.publicUrl,
    file_name: file.name,
    file_size: file.size,
    file_type: file.type
  }).select('*, profiles(id,name)').single();

  if (newMsg) {
    document.getElementById('bc-messages').appendChild(bcRenderMsg(newMsg));
    bcScrollToBottom();
    showToast('Fil sendt! üìé');
  }
  input.value = '';
}

function bcOpenContext(e, btn, isMe, msgId) {
  e.stopPropagation();
  bcCurrentMsgId = msgId;
  document.getElementById('bc-ctx-edit').style.display = isMe ? 'flex' : 'none';
  const menu = document.getElementById('bc-context-menu');
  menu.style.display = 'block';
  menu.classList.add('open');
  const r = btn.getBoundingClientRect();
  let top = r.bottom + 4;
  let left = isMe ? r.right - 175 : r.left - 5;
  left = Math.max(8, Math.min(left, window.innerWidth - 185));
  menu.style.top = top + 'px';
  menu.style.left = left + 'px';
  setTimeout(() => document.addEventListener('click', bcCloseContext, {once:true}), 10);
}

function bcCloseContext() {
  const m = document.getElementById('bc-context-menu');
  m.classList.remove('open');
  setTimeout(() => m.style.display='none', 150);
}

function bcStartEdit() {
  if (!bcCurrentMsgId) return;
  bcCloseContext();
  bcEditingId = bcCurrentMsgId;
  const bubbleEl = document.getElementById('bc-bubble-' + bcEditingId);
  if (!bubbleEl) return;
  document.getElementById('bc-input').value = bubbleEl.textContent;
  document.getElementById('bc-input').focus();
  document.getElementById('bc-edit-bar').classList.add('show');
  document.getElementById('bc-send-btn').textContent = '‚úì';
}

function bcCancelEdit() {
  bcEditingId = null;
  document.getElementById('bc-input').value = '';
  document.getElementById('bc-edit-bar').classList.remove('show');
  document.getElementById('bc-send-btn').textContent = '‚Üí';
}

async function bcDeleteMessage() {
  if (!bcCurrentMsgId) return;
  bcCloseContext();
  await sb.from('bubble_messages').delete().eq('id', bcCurrentMsgId).eq('user_id', currentUser.id);
  document.getElementById('bc-msg-' + bcCurrentMsgId)?.remove();
  showToast('Besked slettet');
}

async function bcShowHistory(msgId) {
  const { data: edits } = await sb.from('bubble_message_edits')
    .select('content, edited_at').eq('message_id', msgId).order('edited_at', {ascending:true});
  const { data: current } = await sb.from('bubble_messages').select('content').eq('id', msgId).single();
  if (!edits || edits.length === 0) { showToast('Ingen historik'); return; }
  const modal = document.getElementById('modal-edit-history') || bcCreateHistoryModal();
  const content = document.getElementById('edit-history-content');
  content.innerHTML = edits.map((e,i) => {
    const t = new Date(e.edited_at).toLocaleTimeString('da-DK',{hour:'2-digit',minute:'2-digit'});
    return `<div style="padding:0.55rem 0;border-bottom:1px solid var(--border)">
      <div style="font-size:0.62rem;color:var(--muted);margin-bottom:0.2rem;font-family:monospace">${i===0?'Originalt':'Redigeret '+i} ¬∑ ${t}</div>
      <div style="font-size:0.82rem;color:var(--muted)">${escHtml(e.content)}</div>
    </div>`;
  }).join('') + `<div style="padding:0.55rem 0"><div style="font-size:0.62rem;color:var(--muted);margin-bottom:0.2rem;font-family:monospace">Nuv√¶rende</div><div style="font-size:0.82rem">${escHtml(current?.content||'')}</div></div>`;
  openModal('modal-edit-history');
}

function bcCreateHistoryModal() {
  const m = document.createElement('div');
  m.id = 'modal-edit-history';
  m.className = 'modal';
  m.innerHTML = `<div class="modal-content"><div class="modal-header"><div class="modal-title">üìù Redigeringshistorik</div><button class="modal-close" onclick="closeModal('modal-edit-history')">‚úï</button></div><div id="edit-history-content" style="padding:0 1.25rem 1rem;overflow-y:auto;max-height:60vh"></div></div>`;
  document.getElementById('app-root').appendChild(m);
  return m;
}

async function bcLoadMembers() {
  const list = document.getElementById('bc-members-list');
  list.innerHTML = '<div class="spinner"></div>';
  const { data: members } = await sb.from('bubble_members')
    .select('user_id, joined_at, profiles(id,name,title)')
    .eq('bubble_id', bcBubbleId)
    .order('joined_at', {ascending:true});

  if (!members || members.length === 0) { list.innerHTML = '<div class="empty-state"><div class="empty-icon">üë•</div><div class="empty-text">Ingen medlemmer</div></div>'; return; }

  const colors = ['linear-gradient(135deg,#065F46,#10B981)','linear-gradient(135deg,#7C2D12,#F97316)','linear-gradient(135deg,#1E3A8A,#7C3AED)','linear-gradient(135deg,#4C1D95,#A78BFA)','linear-gradient(135deg,#0C4A6E,#38BDF8)'];
  const isOwner = bcBubbleData?.created_by;

  list.innerHTML = `<div class="chat-section-label">Ejer</div>`;
  const owner = members.find(m => m.user_id === isOwner);
  const others = members.filter(m => m.user_id !== isOwner);
  const all = owner ? [owner, ...others] : members;
  let shownOwner = false;

  list.innerHTML += all.map((m, i) => {
    const p = m.profiles || {};
    const initials = (p.name||'?').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
    const color = colors[i % colors.length];
    const isOwnerRow = m.user_id === isOwner;
    const label = shownOwner ? '' : (isOwnerRow ? (shownOwner=true,'') : '');
    const sectionBreak = !shownOwner && !isOwnerRow ? (shownOwner=true,'<div class="chat-section-label" style="margin-top:0.8rem">Medlemmer ¬∑ '+(others.length)+'</div>') : '';
    return `${sectionBreak}<div class="chat-member-row" onclick="bcOpenPerson('${m.user_id}','${p.name||''}','${p.title||''}','${color}')">
      <div class="chat-member-avatar" style="background:${color}">${initials}</div>
      <div style="flex:1"><div class="chat-member-name">${escHtml(p.name||'Ukendt')}</div><div class="chat-member-status">${p.title||''}</div></div>
      ${isOwnerRow ? '<span class="chat-member-role">Ejer</span>' : ''}
    </div>`;
  }).join('');
}

async function bcLoadInfo() {
  const list = document.getElementById('bc-info-list');
  if (!bcBubbleData) await bcLoadBubbleInfo();
  const b = bcBubbleData;
  if (!b) return;
  const tags = (b.keywords||[]).map(k=>`<span class="tag">${escHtml(k)}</span>`).join('');
  list.innerHTML = `
    <div class="chat-info-block"><div class="chat-info-label">Beskrivelse</div><div class="chat-info-val">${escHtml(b.description||'Ingen beskrivelse')}</div></div>
    <div class="chat-info-block"><div class="chat-info-label">Interesser</div><div style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-top:0.4rem">${tags||'‚Äì'}</div></div>
    <div class="chat-info-block"><div class="chat-info-label">Boble-type</div><div class="chat-info-val">${typeLabel(b.type)}</div></div>
    <div class="chat-info-block"><div class="chat-info-label">Sted</div><div class="chat-info-val">${escHtml(b.location||'Ikke angivet')}</div></div>
    <div>
      <button class="chat-info-btn primary" onclick="openQRModal('${b.id}')">üîó Del boble / QR-kode</button>
      <button class="chat-info-btn danger" onclick="leaveBubble('${b.id}')">‚Ü© Forlad boblen</button>
    </div>`;
}

// Person sheet from chat avatar
function bcOpenPerson(userId, name, title, color) {
  const initials = (name||'?').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
  document.getElementById('ps-avatar').style.background = color;
  document.getElementById('ps-avatar').textContent = initials;
  document.getElementById('ps-name').textContent = name || 'Ukendt';
  document.getElementById('ps-sub').textContent = title || '';
  document.getElementById('ps-bio').textContent = '';
  document.getElementById('ps-bubbleup-btn').style.display = 'flex';
  document.getElementById('ps-bubbleup-confirm').classList.remove('show');
  // Store userId
  document.getElementById('person-sheet-el').dataset.userId = userId;
  document.getElementById('person-sheet-el').dataset.userName = name;
  document.getElementById('ps-overlay').classList.add('open');
  setTimeout(() => document.getElementById('person-sheet-el').classList.add('open'), 10);
}

function psClose() {
  document.getElementById('person-sheet-el').classList.remove('open');
  document.getElementById('ps-bubbleup-btn').style.display = 'flex';
  document.getElementById('ps-bubbleup-confirm').classList.remove('show');
  setTimeout(() => document.getElementById('ps-overlay').classList.remove('open'), 320);
}

function psMessage() { const uid = document.getElementById('person-sheet-el').dataset.userId; psClose(); setTimeout(() => openChat(uid), 350); }
function psProfile() { const uid = document.getElementById('person-sheet-el').dataset.userId; psClose(); setTimeout(() => openPerson(uid, 'screen-bubble-chat'), 350); }
function psMeeting() { const uid = document.getElementById('person-sheet-el').dataset.userId; psClose(); setTimeout(() => { currentPerson = uid; proposeMeeting(); }, 350); }

function psTriggerBubbleUp() {
  const name = document.getElementById('person-sheet-el').dataset.userName?.split(' ')[0] || 'personen';
  document.getElementById('ps-bubbleup-name').textContent = name;
  document.getElementById('ps-bubbleup-btn').style.display = 'none';
  document.getElementById('ps-bubbleup-confirm').classList.add('show');
}

function psCancelBubbleUp() {
  document.getElementById('ps-bubbleup-btn').style.display = 'flex';
  document.getElementById('ps-bubbleup-confirm').classList.remove('show');
}

async function psConfirmBubbleUp() {
  const toUserId = document.getElementById('person-sheet-el').dataset.userId;
  const name = document.getElementById('person-sheet-el').dataset.userName?.split(' ')[0] || 'personen';
  await sendBubbleUpInvitation(toUserId);
  psClose();
  showToast('ü´ß Invitation sendt til ' + name + '!');
}

// Bubble-up from screen-person
function personTriggerBubbleUp() {
  const name = (document.getElementById('person-name')?.textContent||'').split(' ')[0] || 'personen';
  document.getElementById('person-bubbleup-name').textContent = name;
  document.getElementById('person-bubbleup-btn').style.display = 'none';
  document.getElementById('person-bubbleup-confirm').classList.add('show');
}

function personCancelBubbleUp() {
  document.getElementById('person-bubbleup-btn').style.display = 'flex';
  document.getElementById('person-bubbleup-confirm').classList.remove('show');
}

async function personConfirmBubbleUp() {
  if (!currentPerson) return;
  const name = (document.getElementById('person-name')?.textContent||'').split(' ')[0] || 'personen';
  await sendBubbleUpInvitation(currentPerson);
  personCancelBubbleUp();
  showToast('ü´ß Invitation sendt til ' + name + '!');
}

async function sendBubbleUpInvitation(toUserId) {
  // Create a hidden private bubble first
  const myName = currentProfile?.name || 'Min boble';
  const theirName = (document.getElementById('person-name')?.textContent || document.getElementById('ps-name')?.textContent || '');
  const { data: bubble } = await sb.from('bubbles').insert({
    name: myName.split(' ')[0] + ' & ' + (theirName.split(' ')[0] || 'ven'),
    type: 'standard',
    visibility: 'hidden',
    created_by: currentUser.id,
    description: 'Privat boble'
  }).select().single();

  if (!bubble) { showToast('Noget gik galt'); return; }

  // Add creator as member
  await sb.from('bubble_members').insert({bubble_id: bubble.id, user_id: currentUser.id});

  // Send invitation
  await sb.from('bubble_invitations').insert({
    bubble_id: bubble.id,
    from_user_id: currentUser.id,
    to_user_id: toUserId
  });
}


function setTheme(theme) {
  document.getElementById('app-root').setAttribute('data-theme', theme);
  localStorage.setItem('bubble-theme', theme);
  document.querySelectorAll('.theme-option').forEach(b => {
    b.classList.toggle('active', b.dataset.theme === theme);
  });
  // Update dropdown button
  const opt = document.querySelector(`.theme-option[data-theme="${theme}"]`);
  if (opt) {
    document.getElementById('theme-swatch-preview').style.background = opt.dataset.preview;
    document.getElementById('theme-label-current').textContent = opt.dataset.label;
  }
}

function toggleThemeDropdown() {
  const dd = document.getElementById('theme-dropdown');
  const chevron = document.getElementById('theme-chevron');
  const open = dd.style.display === 'block';
  dd.style.display = open ? 'none' : 'block';
  chevron.style.transform = open ? 'rotate(0deg)' : 'rotate(180deg)';
}

function selectTheme(el) {
  setTheme(el.dataset.theme);
  document.getElementById('theme-dropdown').style.display = 'none';
  document.getElementById('theme-chevron').style.transform = 'rotate(0deg)';
}

updateClock();
setInterval(updateClock, 10000);
window.addEventListener('load', async () => {
  const savedTheme = localStorage.getItem('bubble-theme') || 'midnight';
  setTheme(savedTheme);
  await checkAuth();
  await checkQRJoin();
  await checkPendingJoin();
  if (currentUser) {
    updateUnreadBadge();
    subscribeToIncoming();
  }
});
</script>

</body>
</html>
